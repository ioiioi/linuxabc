<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>kvm | linuxabc</title>
  <meta name="author" content="alfie chan">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="linuxabc"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="linuxabc" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">linuxabc</a></h1>
  <h2><a href="/">focus on security, network management and embeded OS</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
<h2 class="archive-title category">kvm</h2>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-01-01T07:00:00.000Z"><a href="/2013/01/01/2013-01-01-KVM-installation/">2013-01-1</a></time>
      
      
  
    <h1 class="title"><a href="/2013/01/01/2013-01-01-KVM-installation/">KVM安装</a></h1>
  

    </header>
    <div class="entry">
      
        <p>node服务器硬件：</p>
<ul>
<li>2 * Intel Xeon（支持虚拟化）</li>
<li>4 * broadcom千兆网卡</li>
<li>2 * SAS 300G硬盘</li>
</ul>
<h1>安装</h1>
<figure class="highlight"><pre><span class="preprocessor"># yum -y groupinstall Virtualization "Virtualization Client" "Virtualization Platform" "Virtualization Tools"</span>
<span class="preprocessor"># yum -y install libguestfs-tools</span>
</pre></figure>

<p>这种安装方式还是不够简洁，可以尝试以下方式：</p>
<figure class="highlight"><pre><span class="preprocessor"># yum -y install qemu-kvm libvirt python-virtinst bridge-utils</span>
<span class="preprocessor"># modprobe kvm</span>
<span class="preprocessor"># modprobe kvm_intel # if AMD, "kvm_amd"</span>
<span class="preprocessor"># /etc/init.d/libvirtd start</span>
</pre></figure>

<p>安装完之后需重启相关服务：</p>
<figure class="highlight"><pre><span class="preprocessor"># service libvirtd status</span>
如果libvirtd没有启动，需要先启动messagebus和avahi-daemon
<span class="preprocessor"># service messagebus start</span>
<span class="preprocessor"># service avahi-daemon start</span>
<span class="preprocessor"># service libvirtd start</span>
</pre></figure>

<p>至此，KVM的安装就结束了，非常简单。不过在生产环境中还需要考虑网络和存储，相对复杂一些，网络拓扑环境如下：</p>
<h1>网络</h1>
<ul>
<li>eth0/eth1做成bond0，通过br0与业务交换机（huawei S5328-1）相连</li>
<li>eth2/eth3做成bond1，通过br1与存储交换机（huawei S5328-2）相连</li>
</ul>
<p>以下是网络配置</p>
<h2>配置网卡</h2>
<figure class="highlight"><pre>[root<span class="variable">@RH2285</span>-<span class="number">4</span> network-scripts]<span class="comment"># cat ifcfg-eth2</span>
<span class="constant">DEVICE</span>=<span class="string">"eth2"</span>
<span class="constant">TYPE</span>=<span class="string">"Ethernet"</span>
<span class="constant">BOOTPROTO</span>=<span class="string">"none"</span>
<span class="constant">ONBOOT</span>=<span class="string">"yes"</span>
<span class="constant">USERCTL</span>=<span class="string">"no"</span>
<span class="constant">MASTER</span>=<span class="string">"bond1"</span>
<span class="constant">SLAVE</span>=<span class="string">"yes"</span>
<span class="constant">NM_CONTROLLED</span>=<span class="string">"no"</span>

[root<span class="variable">@RH2285</span>-<span class="number">4</span> network-scripts]<span class="comment"># cat ifcfg-eth3</span>
<span class="constant">DEVICE</span>=<span class="string">"eth3"</span>
<span class="constant">TYPE</span>=<span class="string">"Ethernet"</span>
<span class="constant">BOOTPROTO</span>=<span class="string">"none"</span>
<span class="constant">ONBOOT</span>=<span class="string">"yes"</span>
<span class="constant">USERCTL</span>=<span class="string">"no"</span>
<span class="constant">MASTER</span>=<span class="string">"bond1"</span>
<span class="constant">SLAVE</span>=<span class="string">"yes"</span>
<span class="constant">NM_CONTROLLED</span>=<span class="string">"no"</span>
</pre></figure>

<h2>配置bonding</h2>
<figure class="highlight"><pre>[root<span class="property">@RH2285</span>-<span class="number">4</span> network-scripts]<span class="comment"># cat /etc/modprobe.d/bonding.conf </span>
alias bond1 bonding

假如没有<span class="regexp">/etc/modprobe.d/</span>bonding.conf，就自己创建一个。

[root<span class="property">@RH2285</span>-<span class="number">4</span> network-scripts]<span class="comment"># lsmod | grep bonding</span>
bonding               <span class="number">127060</span>  <span class="number">0</span> 
<span class="number">8021</span>q                  <span class="number">25058</span>  <span class="number">1</span> bonding
ipv6                  <span class="number">322541</span>  <span class="number">78</span> bonding,ip6t_REJECT,nf_conntrack_ipv6,nf_defrag_ipv6

假如bonding还没有加载，那就手工加载。

<span class="comment"># modprobe bonding</span>

[root<span class="property">@RH2285</span>-<span class="number">4</span> network-scripts]<span class="comment"># cat ifcfg-bond1</span>
DEVICE=bond1
BRIDGE=br1
USERCTL=<span class="literal">no</span>
BOOTPROTO=none
ONBOOT=<span class="literal">yes</span>
NM_CONTROLLED=<span class="literal">no</span>
BONDING_OPTS=<span class="string">"mode=4 miimon=80"</span>
</pre></figure>

<h2>配置bridge</h2>
<figure class="highlight"><pre>[root<span class="property">@RH2285</span>-<span class="number">4</span> network-scripts]<span class="comment"># cat ifcfg-br1</span>
DEVICE=<span class="string">"br1"</span>
TYPE=Bridge
ONBOOT=<span class="literal">yes</span>
BOOTPROTO=static
IPADDR=<span class="number">192.168</span><span class="number">.55</span><span class="number">.232</span>
NETMASK=<span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>
NETWORK=<span class="number">192.168</span><span class="number">.55</span><span class="number">.0</span>
NM_CONTROLLED=<span class="string">"no"</span>
</pre></figure>

<p>最后重启网络：</p>
<figure class="highlight"><pre>[root<span class="variable">@RH2285</span>-<span class="number">4</span> network-scripts]<span class="comment"># service network restart</span>
</pre></figure>

<h2>检查</h2>
<figure class="highlight"><pre>[root@<span class="class">RH2285</span>-<span class="number">4</span> network-scripts]# cat /proc/net/bonding/bond1
<span class="class">Ethernet</span> <span class="class">Channel</span> <span class="class">Bonding</span> <span class="class">Driver</span>: v3<span class="number">.6</span><span class="number">.0</span> (<span class="class">September</span> <span class="number">26</span>, <span class="number">2009</span>)

<span class="class">Bonding</span> <span class="class">Mode</span>: <span class="class">IEEE</span> <span class="number">802.3</span>ad <span class="class">Dynamic</span> link aggregation
<span class="class">Transmit</span> <span class="class">Hash</span> <span class="class">Policy</span>: layer2 (<span class="number">0</span>)
<span class="class">MII</span> <span class="class">Status</span>: up
<span class="class">MII</span> <span class="class">Polling</span> <span class="class">Interval</span> (ms): <span class="number">80</span>
<span class="class">Up</span> <span class="class">Delay</span> (ms): <span class="number">0</span>
<span class="class">Down</span> <span class="class">Delay</span> (ms): <span class="number">0</span>

<span class="number">802.3</span>ad info
<span class="class">LACP</span> <span class="method">rate:</span> slow
<span class="class">Aggregator</span> selection policy (ad_select): stable
<span class="class">Active</span> <span class="class">Aggregator</span> <span class="class">Info</span>:
        <span class="class">Aggregator</span> <span class="class">ID</span>: <span class="number">3</span>
        <span class="class">Number</span> of <span class="method">ports:</span> <span class="number">2</span>
        <span class="class">Actor</span> <span class="class">Key</span>: <span class="number">17</span>
        <span class="class">Partner</span> <span class="class">Key</span>: <span class="number">305</span>
        <span class="class">Partner</span> <span class="class">Mac</span> <span class="class">Address</span>: <span class="number">54</span>:<span class="number">89</span>:<span class="number">98</span>:<span class="number">73</span>:<span class="method">bb:</span><span class="number">07</span>

<span class="class">Slave</span> <span class="class">Interface</span>: eth2
<span class="class">MII</span> <span class="class">Status</span>: up
<span class="class">Speed</span>: <span class="number">1000</span> <span class="class">Mbps</span>
<span class="class">Duplex</span>: full
<span class="class">Link</span> <span class="class">Failure</span> <span class="class">Count</span>: <span class="number">0</span>
<span class="class">Permanent</span> <span class="class">HW</span> <span class="method">addr:</span> <span class="number">3</span><span class="method">c:</span><span class="method">d9:</span><span class="number">2</span><span class="method">b:</span><span class="method">fd:</span><span class="number">39</span>:f0
<span class="class">Aggregator</span> <span class="class">ID</span>: <span class="number">3</span>
<span class="class">Slave</span> queue <span class="class">ID</span>: <span class="number">0</span>

<span class="class">Slave</span> <span class="class">Interface</span>: eth3
<span class="class">MII</span> <span class="class">Status</span>: up
<span class="class">Speed</span>: <span class="number">1000</span> <span class="class">Mbps</span>
<span class="class">Duplex</span>: full
<span class="class">Link</span> <span class="class">Failure</span> <span class="class">Count</span>: <span class="number">0</span>
<span class="class">Permanent</span> <span class="class">HW</span> <span class="method">addr:</span> <span class="number">3</span><span class="method">c:</span><span class="method">d9:</span><span class="number">2</span><span class="method">b:</span><span class="method">fd:</span><span class="number">39</span>:f2
<span class="class">Aggregator</span> <span class="class">ID</span>: <span class="number">3</span>
<span class="class">Slave</span> queue <span class="class">ID</span>: <span class="number">0</span>
[root@<span class="class">RH2285</span>-<span class="number">4</span> network-scripts]# ifconfig br1
[root@<span class="class">RH2285</span>-<span class="number">4</span> network-scripts]# brctl show
</pre></figure>

<p>网络配置完成之后，可从其它机器ssh登录br1的ip地址，测试网络是否可正常工作。</p>
<h1>存储</h1>
<p>关于OS的选择<br>ZFS是一块瑰宝，发迹于solaris，sun公司曾与2005年开源了solaris，取名为opensolaris，那时已经有很多人垂涎于其ZFS，FreeBSD开发者也将其移植过来，Linux开发者则系统通过FUSE的方式引入，不过这两者在当时都不成气候，特别是linux的ZFS，由于跑在userland，其性能根本无法匹敌。<br>oracle收购了sun之后，又将solaris闭源了，开源社区对此大势抨击，我倒觉得无此必要，毕竟Oracle还有那么多工程师要养活，收购过来的资产不能变现，Oracle又不是慈善机构，凭什么要免费提供这么优质的软件？<br>另一帮人则看到了商机，于是诞生了nexenta、smartos这样的产品，其中nexenta是debian+zfs的混种，本质上还是solaris，只不过用了apt方式管理软件包。这是第一个成功打入市场的产品，拥有ZFS全部的优秀品质，同时套了层漂亮的webui，也获得不少青睐，最要命的是可以免费使用，唯一的限制是18T。<br>另一个公司joynet，说起这个公司也不简单，node.js就出自该公司的手笔，它的光芒掩盖了joynet公司的另一项主营业务：VPS，joynet搜罗了不少sun的工程师，sun的工程师真是有骨气，他们为了信念而工作，拥有工程师气质的sun为我们奉献了solaris、dtrace、zfs、java、nfs等等脍炙人口的作品，可惜的是最终还是陨落了。不仅仅是为了面包，至少java的高司令便是如此，首席工程师于2010年将KVM移植到了illious，从此，SmartOS诞生了，它具有以下的优点：<br>ZFS<br>KVM<br>container<br>DTrace<br>每一项技术仿佛都是为了VPS而生，因此SmartOS广告语是“”。<br>我尚未测试该OS的性能和稳定性，不过国内已经有一家创业型VPS用了该技术。<br>就像Linux一样，illious的以惊人的速度发展着，然而历史是如此的相似，Linux的发行版众多，illious社区也陷入的同样的怪圈，统一内核，发行版就由众多开源社区进行维护吧。<br>截至到目前为止，共有openindiana、smartos、omnios、nexenta等多种发行版，与linux不同的是，linux内核由linus一个人说了算，然而illous的开发则受到其赞助商的左右，翻开官网就会看到、joynet、nexenta是背后的。<br>linux和illous这两种不同的开发模式，孰优孰劣只能留待历史进行评判，不过它告诉了我们一个真理，没钱的活没人干，至少干不好。</p>
<p>“STOP，你当你谁啊！说书的吗？说了那么多到底该选哪个？”观众估计已经开始拖鞋了。<br>说实在话，我也不知道该选哪个，这绝不是忽悠，因为目前的状态实在是太混乱了。我斗胆做了以下的选择建议：<br>纯粹的storage：solaris11，solaris11的ZFS版本已经发展到了v34，ilmous因为它才是ZFS的正宗，瘦死的骆驼比马大<br>云计算OS：smartos，该公司的另一项主营业务就是VPS，它不能拿命根子开玩笑<br>FreeNAS vs nexenta，如果真要在这两者之间做一个选择的话，那还是nexenta吧，毕竟</p>
<p>它获得了很大的市场，而且依赖着illous这颗大树，FreeBSD的ZFS前景我觉得并不容乐观。<br>其它的，暂时还是忘了吧。</p>
<p>遭受诟病</p>
<p>可以选择本地存储，也可以选择外置存储，本例中选择nfs作为storage backend。</p>
<p>how-to-make-usb-dos<br>制作USB DOS启动盘</p>
<p>how-to-config-bios-of-supermicro-mobo<br>配置supermicro主板的bios</p>
<p>服务器第一次启动后，按Del键，待LSI检测完毕后进入BIOS进行配置：</p>
<p>1、启用VT-d，SRV-IO，VT-x等虚拟化选项<br>2、将SATA配置从IDE改成AHCI<br>3、将启动顺序设为：<br>USB<br>USB-CDROM<br>Harddisk</p>
<p>how-to-flash-it-firmware-on-lsi2008</p>
<p>supermicro X8DT6-F主板自带的SAS控制器是LSI 2008，出厂默认模式是IR，而ZFS需要的是IT，因此需要先将LSI 2008的firmware刷成IT模式。</p>
<ul>
<li>从supermirco网站下载<a href="ftp://ftp.supermicro.com/driver/SAS/LSI/2008/IT/Firmware/">LSI 2008的IT firmware</a></li>
<li>将firmware解压到<a href="how-to-make-usb-dos">usb dos启动盘</a>的根目录下</li>
<li>启动服务器，按“Del”键进入BIOS，<a href="how-to-config-bios-of-supermicro-mobo">修改相关配置</a>，在启动顺序中将“USB选项”置顶</li>
<li>在dos提示符下执行<code>C:\&gt;SMC2008.bat</code></li>
<li>最后将出现以下提示符</li>
</ul>
<figure class="highlight"><pre>Enter <span class="keyword">the</span> remaining <span class="number">9</span> digits <span class="keyword">for</span> <span class="keyword">the</span> sas address: <span class="number">004</span>DF3A00
</pre></figure>

<p>根据要求请输出SAS控制器的地址，提示：SAS控制器地址一般贴在主板正面，或是LSI板卡上。</p>
<p>否则服务器重启后会出现以下提示：</p>
<figure class="highlight"><pre><span class="title">SAS</span> address NOT program <span class="built_in">on</span> controller slot <span class="number">4</span>
</pre></figure>

<p>原因是：</p>
<blockquote>
<p>I too had the issue where the flash util refused to flash over the existing firmware.<br>I used the sas2flash -o -e 7 line posted in the comments and it worked. BUT it erased the WWN number from the card giving me an error every boot about the SAS address not being programmed.<br>SO DO NOT USE sas2flash -o -e 7. Instead use sas2flash -o -e 6. That will erase the flash but it won’t erase the manufacturing area which contains the WWN.<br>If you do erase the wwn. You’ll need to reenter it using sas2flash -o -sasadd (wwn number). Usually this number is on a sticker somewhere on the card or motherboard.<br>If you can’t find it. You can make up an 8 byte hex number. A WWN is like an ethernet mac address. Every card in the system needs to have a unique one.</p>
</blockquote>
<p>参考：<a href="http://www.servethehome.com/howto-flash-supermicro-x8si6f-lsi-sas-2008-controller-lsi-firmware/" target="_blank">http://www.servethehome.com/howto-flash-supermicro-x8si6f-lsi-sas-2008-controller-lsi-firmware/</a></p>
<p>至此，LSI 2008完成了从IR到IT的转变。</p>
<p>安装操作系统</p>
<p>将USB DOS启动盘拔出，插上USB光驱，启动后插入solaris 10 u 10安装盘，选择3，进入solaris的安装阶段。<br>选择entire system，8个G，<br>在分区的时候，solaris默认会将整块硬盘安装操作系统，但是对于宝贵的SSD资源来说就太浪费了，因此将solaris分区缩小：<br>1、先删除solaris分区；<br>2、新建一个分区，分区格式为solaris，大小为20000M，即20G</p>
<p>stmsboot -e<br>该命令将<br>Prtconf -v | less<br>查找:inquiry-serial-no<br>记录下所有的硬盘序列号</p>
<p>安装存储操作系统<br>一、nexentastor CE 3.1.1</p>
<p>准备工作<br>下载ISO</p>
<p>刻录</p>
<p>安装<br>安装过程详见：<br>需要注意的是，选择系统盘的时候，将整个系统盘作为一个syspool，不要安装在某个分区上。</p>
<p>配置</p>
<p>网络</p>
<p>svcadm disable network/physical:nwam<br>svcadm enable network/physical:default</p>
<p>一、确保所有网口没有被启用<br>ifconfig e1000g0 unplumb<br>ifconfig e1000g1 unplumb</p>
<p>二、创建link-aggregation<br>dladm create-aggr -l e1000g0 -l e1000g1 interlink0</p>
<p>三、启用端口汇聚<br>ifconfig plumb interlink0</p>
<p>四、配置ip地址<br>ifconfig interlink0 192.168.33.11/24 broadcast + up</p>
<p>五、配置JumboFrame<br>Dladm set-linkprop -p mtu=9000 aggr0<br>Dladm show-linkprop -p mtu</p>
<p>说明：<br>假如之前配置了一个网卡，残留：/etc/hostname.e1000g0这样的文件，这时候需要将该文件更名为hostname.aggr0<br>Mv /etc/hostname.e1000g0 /etc/hostname.aggr0，否则重启后会出错，network/physical:default无法正常启动，出于maintance状态。</p>
<p>默认路由<br>route -p add default 192.168.84.1</p>
<p>DNS<br>cp /etc/nsswitch.dns /etc/nsswitch.conf<br>或者：<br>修改/etc/nsswitch.conf<br>ipnodes: files mdns<br>hosts:files mdns</p>
<p>修改/etc/resolv.conf<br>添加dns服务器<br>Nameserver 8.8.8.8</p>
<p>zfs<br>Syspool mirror<br>将磁盘分区信息复制到备用盘<br>/usr/sbin/prtvtoc /dev/rdsk/c0t50014EE100803078d0s2 | /usr/sbin/fmthard -s - /dev/rdsk/c0t50014EE10080334Ad0s2</p>
<p>附着备用盘<br>zpool attach -f rpool c0t50014EE100803078d0s0 c0t50014EE10080334Ad0s0</p>
<p>在备用盘上安装grub<br>installgrub -m /boot/grub/stage1 /boot/grub/stage2 /dev/rdsk/c0t50014EE10080334Ad0s0</p>
<p>在bios中设置启动顺序，主盘为第一启动设备，副盘为第二启动设备。</p>
<p>这样，即便主盘换掉，仍然可以通过备用盘启动。</p>
<p>Zpool<br>Zpool create tank mirror disk1 disk2<br>Zpool add tank mirror disk3 disk3<br>Zpool add tank mirror disk5 disk6<br>….</p>
<p>sLog（ZIL）和log<br>Zpool add tank log mirror disk7 disk8</p>
<p>Zpool add tank cache disk 9<br>Zpool add tank cache disk 10</p>
<p>创建文件系统和共享</p>
<p>For XenServer SR</p>
<p>1、创建NFS VHD pool</p>
<h1>Zfs create tank/XenSrv-SR</h1>
<p>共享</p>
<p>2、创建NFS ISO pool</p>
<h1>Zfs create tank/iso</h1>
<p>共享</p>
<p>将iso灌入该文件系统中，如果是windows，可以用hfs开启http共享，然后在nexenta中使用wget命令将iso文件下载到该文件系统中</p>
<h1>安装solaris 11 text x86</h1>
<h2>初始化配置</h2>
<p>**帐号</p>
<p>**ssh</p>
<p>**</p>
<h2>一、配置网络</h2>
<h2>二、准备硬盘列表和位置图</h2>
<p>1、抄下所有硬盘的wwn（印在硬盘正面）<br>2、运行<br>prtconf -v | less<br>查找wwn，记下对应的serial number<br>3、</p>
<h2>三、创建tank zpool</h2>
<figure class="highlight"><pre>root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zpool create tank mirror c0t50014EE0AD455A8Fd0 c0t50014EE0029B5CAAd0</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zpool add tank mirror c0t50014EE0AD462C12d0 c0t50014EE0AD463639d0</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zpool add tank mirror c0t50014EE0AD465EBEd0 c0t50014EE0AD463716d0</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zpool add tank mirror c0t50014EE057F05F1Fd0 c0t50014EE0029B543Bd0</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zpool add tank mirror c0t50014EE0029B486Dd0 c0t50014EE0AD463486d0</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zpool add tank mirror c0t50014EE0029B523Fd0 c0t50014EE0AD4636F6d0</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zpool add tank mirror c0t50014EE0AD463101d0 c0t50014EE057F07D4Ed0</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zpool add tank mirror c0t50014EE0AD46346Fd0 c0t50014EE057F087C5d0</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zpool add tank mirror c0t50014EE0029B4C86d0 c0t50014EE057F08506d0</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zpool add tank log mirror c5t0d0 c5t1d0</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zpool add tank cache c0t5001517A6BE5DA38d0</span>
</pre></figure>

<h2>创建zfs文件系统</h2>
<p>下面初步拟定的文件系统结构：</p>
<p>1、tank/iso<br>               /iso/linux<br>               /iso/windows<br>               /iso/BSD</p>
<p>2、tank/VMs<br>               /VMs/VMware<br>               /VMs/OSS-XEN<br>               /VMs/XenSrv-XCP</p>
<p>3、tank/VM-template<br>               /VM-template/Vmware<br>               /VM-template/OSS-XEN<br>               /VM-template/XenSrv-XCP<br>               /VM-template/KVM</p>
<p>4、tank/software<br>               /software/windows<br>               /software/Linux<br>               /software/BSD</p>
<figure class="highlight"><pre>root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs create tank/iso</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs create tank/iso/linux</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs create tank/iso/windows</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs create tank/iso/bsd</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs create tank/VMs</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs create tank/VMs/VMware</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs create tank/VMs/oss-xen</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs create tank/VMs/xensrv-xcp</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs create tank/VM-template</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs create tank/VM-template/VMware</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs create tank/VM-template/oss-xen</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs create tank/VM-template/xensrv-xcp</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs create tank/VM-template/kvm</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs create tank/software</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs create tank/software/windows</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs create tank/software/linux</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs create tank/software/bsd</span>
</pre></figure>

<h2>启用nfs共享</h2>
<figure class="highlight"><pre>root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs set sharenfs=on tank/VMs/opennebula</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># zfs set share=name=tank_VMs_opennebula,path=/tank/VMs/opennebula,prot=nfs,anon=0,sec=sys,rw=* tank/VMs/opennebula</span>
root<span class="variable">@dsStorage</span><span class="symbol">:~</span><span class="comment"># chmod 777 /tank/VMs/opennebula</span>
</pre></figure>


      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  

  <nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav>
</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:ioiioi.github.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/RouterOS/MikroTik/">MikroTik</a><small>2</small></li>
  
    <li><a href="/categories/RouterBOARD/">RouterBOARD</a><small>1</small></li>
  
    <li><a href="/categories/RouterOS/">RouterOS</a><small>4</small></li>
  
    <li><a href="/categories/VPS/">VPS</a><small>1</small></li>
  
    <li><a href="/categories/openwrt/ap/">ap</a><small>1</small></li>
  
    <li><a href="/categories/confluence/">confluence</a><small>1</small></li>
  
    <li><a href="/categories/debian/">debian</a><small>12</small></li>
  
    <li><a href="/categories/dhcp/debian/">debian</a><small>1</small></li>
  
    <li><a href="/categories/dns/debian/">debian</a><small>1</small></li>
  
    <li><a href="/categories/ldap/debian/">debian</a><small>1</small></li>
  
    <li><a href="/categories/dhcp/">dhcp</a><small>1</small></li>
  
    <li><a href="/categories/dns/">dns</a><small>1</small></li>
  
    <li><a href="/categories/debian/domU/">domU</a><small>1</small></li>
  
    <li><a href="/categories/ubuntu/domU/">domU</a><small>1</small></li>
  
    <li><a href="/categories/embeded/">embeded</a><small>1</small></li>
  
    <li><a href="/categories/freebsd/">freebsd</a><small>1</small></li>
  
    <li><a href="/categories/illumos/">illumos</a><small>1</small></li>
  
    <li><a href="/categories/iptable/">iptable</a><small>1</small></li>
  
    <li><a href="/categories/virtualization/iscsi/">iscsi</a><small>1</small></li>
  
    <li><a href="/categories/xen/kvm/">kvm</a><small>1</small></li>
  
    <li><a href="/categories/kvm/">kvm</a><small>1</small></li>
  
    <li><a href="/categories/network/ldap/">ldap</a><small>1</small></li>
  
    <li><a href="/categories/ldap/">ldap</a><small>1</small></li>
  
    <li><a href="/categories/openwrt/linksys/">linksys</a><small>1</small></li>
  
    <li><a href="/categories/linux/">linux</a><small>1</small></li>
  
    <li><a href="/categories/linux/netbsd/">netbsd</a><small>1</small></li>
  
    <li><a href="/categories/openbsd/netmgmt/">netmgmt</a><small>1</small></li>
  
    <li><a href="/categories/openwrt/vpn/network/">network</a><small>1</small></li>
  
    <li><a href="/categories/debian/network/">network</a><small>2</small></li>
  
    <li><a href="/categories/network/">network</a><small>3</small></li>
  
    <li><a href="/categories/networking/">networking</a><small>1</small></li>
  
    <li><a href="/categories/nexenta/">nexenta</a><small>4</small></li>
  
    <li><a href="/categories/octopress/">octopress</a><small>3</small></li>
  
    <li><a href="/categories/debian/octopress/">octopress</a><small>2</small></li>
  
    <li><a href="/categories/openSUSE/">openSUSE</a><small>2</small></li>
  
    <li><a href="/categories/openbsd/">openbsd</a><small>8</small></li>
  
    <li><a href="/categories/openbsd openntpd/">openbsd openntpd</a><small>1</small></li>
  
    <li><a href="/categories/openwrt/">openwrt</a><small>4</small></li>
  
    <li><a href="/categories/others/">others</a><small>1</small></li>
  
    <li><a href="/categories/seafile/">seafile</a><small>1</small></li>
  
    <li><a href="/categories/seafile/services/">services</a><small>1</small></li>
  
    <li><a href="/categories/linux/netbsd/solaris/">solaris</a><small>1</small></li>
  
    <li><a href="/categories/RouterBOARD/solaris11/">solaris11</a><small>1</small></li>
  
    <li><a href="/categories/solaris11/">solaris11</a><small>1</small></li>
  
    <li><a href="/categories/tech/">tech</a><small>1</small></li>
  
    <li><a href="/categories/tech/tips/">tips</a><small>1</small></li>
  
    <li><a href="/categories/ubuntu/">ubuntu</a><small>1</small></li>
  
    <li><a href="/categories/vim/">vim</a><small>1</small></li>
  
    <li><a href="/categories/windows/virtualbox/">virtualbox</a><small>1</small></li>
  
    <li><a href="/categories/virtualbox/">virtualbox</a><small>5</small></li>
  
    <li><a href="/categories/debian/virtualbox/">virtualbox</a><small>1</small></li>
  
    <li><a href="/categories/virtualization/">virtualization</a><small>2</small></li>
  
    <li><a href="/categories/kvm/virtualization/">virtualization</a><small>1</small></li>
  
    <li><a href="/categories/openwrt/vpn/">vpn</a><small>1</small></li>
  
    <li><a href="/categories/vpn/">vpn</a><small>1</small></li>
  
    <li><a href="/categories/windows/">windows</a><small>1</small></li>
  
    <li><a href="/categories/virtualization/xen/">xen</a><small>1</small></li>
  
    <li><a href="/categories/ubuntu/domU/xen/">xen</a><small>1</small></li>
  
    <li><a href="/categories/xen/">xen</a><small>2</small></li>
  
    <li><a href="/categories/debian/domU/xen/">xen</a><small>1</small></li>
  
    <li><a href="/categories/illumos/zfs/">zfs</a><small>1</small></li>
  
    <li><a href="/categories/xen/kvm/虚拟化/">虚拟化</a><small>1</small></li>
  
  </ul>
</div>


  
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2013 alfie chan
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>