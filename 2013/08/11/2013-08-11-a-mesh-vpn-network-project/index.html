<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>a mesh network | linuxabc</title>
  <meta name="author" content="alfie chan">
  
  <meta name="description" content="mesh network看起来很牛，实际上也的确非常牛。这个小项目的初衷源于一个小小的需求：允许外网用户透过公司网络访问用户侧的一台设备。后来我对这张网络的期望越来越大，需求不断的叠加，最后演变成一个mesh network。由于各个互联节点分散在内外网，故需要用到vpn，所以题目就叫a mesh vpn network project。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="a mesh network"/>
  <meta property="og:site_name" content="linuxabc"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="linuxabc" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">linuxabc</a></h1>
  <h2><a href="/">focus on security, network management and embeded OS</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-08-11T08:00:00.000Z"><a href="/2013/08/11/2013-08-11-a-mesh-vpn-network-project/">2013-08-11</a></time>
      
      
  
    <h1 class="title">a mesh network</h1>
  

    </header>
    <div class="entry">
      
        <p>mesh network看起来很牛，实际上也的确非常牛。这个小项目的初衷源于一个小小的需求：允许外网用户透过公司网络访问用户侧的一台设备。后来我对这张网络的期望越来越大，需求不断的叠加，最后演变成一个mesh network。由于各个互联节点分散在内外网，故需要用到vpn，所以题目就叫a mesh vpn network project。</p>
<a id="more"></a>

<p>整个系列分为以下几个部分：</p>
<ol>
<li>需求及配置</li>
<li>tinc vpn<br>2.1 tinc的安装和调试<br>2.2 三种模式<br>2.2.1 路由模式+静态路由<br>2.2.2 交换模式+动态路由<br>2.2.3 路由模式+NAT</li>
<li>其它</li>
</ol>
<h1>需求及配置</h1>
<p>最初的需求是：允许维护人员的笔记本或手机通过互联网访问位于客户2（User2）的网管服务器，第一时间获知故障，缩短修复时长。</p>
<p>::top-orig-purpose.jpg::</p>
<p>公司办公室（corp）可以连接互联网和内网这两张网络，互联网和内网的防火墙均不在我的控制范围之内，corp节点的终端仅拥有tcp/udp的outbound访问权限。那么唯一可行的方案就是首先在互联网上找一个拥有固定IP地址的节点（lab），然后使用vpn技术，分别在lab节点与corp节点，corp节点与User2节点之间建立两条点对点隧道，最后打通corp节点的路由转发，从而实现最初的需求。</p>
<p>::top-orig-tunnel.jpg::</p>
<p>随后便想到，我1、有时在家（home）需要连回公司处理业务；2、在公司需经常处理客户1（User1）的网络故障；索性把这几个节点全部连起来，于是需求变成了：</p>
<h2>需求</h2>
<p>::tinc-vpn-top.jpg::</p>
<h3>功能需求</h3>
<ol>
<li>实现lab、User1、User2、corp和home五个节点之间的互联。</li>
<li>corp节点下挂的终端可以同时访问内网和互联网，提供condition dns forward，即根据不同的域名，前转至不同的DNS server进行解析；</li>
<li>User2节点网关可通过corp节点访问互联网；</li>
</ol>
<h3>安全策略</h3>
<p>5个节点的安全要求不尽相同，User1和User2的安全性要求最高，lab次之，corp和home最低，需要定义严格的访问策略。</p>
<p>默认策略为拒绝</p>
<p>“corp”节点<br>允许节点内主机访问互联网；<br>允许“User2”节点网关访问本节点网关的DNS服务，并通过本节点访问互联网；<br>开启“User1”、“User2”、“lab”、“home”之间的路由转发功能；</p>
<p>“home”节点<br>允许终端访问“lab”、“lab”、“User1”和“User2”节点的内部网段；</p>
<p>“lab”节点<br>允许“home”、“corp”访问SSH、web服务；<br>终端可以自由的访问“User1”和“User2”的内部网段；</p>
<p>“User2”节点<br>允许“lab”、“corp”和“home”特定主机访问节点内网的SSH、web服务；<br>允许本节点网关访问“corp”节点的DNS服务；<br>允许本节点网关通过“corp”节点访问互联网，用于软件升级；</p>
<p>“User1”节点<br>允许“lab”、“corp”和“home”特定主机访问节点内网的SSH、web服务；</p>
<p>所有节点<br>允许节点网关之间互ping</p>
<h2>软硬件配置</h2>
<ol>
<li>lab、User1和User2均有虚拟化环境，为了方便起见，选择虚拟机（debian squeeze）作为节点网关。</li>
<li>考虑到噪音和能耗，选择无线路由器（支持OpenWRT固件）担任corp和home节点网关；</li>
<li>corp节点处于整张网的中心，vpn的加解密工作颇为频繁，对设备性能要求较高，因而选择了一台MikroTik的RB450G。home仅作为末梢节点接入，因而Linksys WRT54G（64M ram，16M flash）足矣。</li>
</ol>
<h1>tinc VPN</h1>
<p>毫无疑问，需要构建一个VPN network，才能实现五个节点的互联。第一个想到的是OpenVPN，它成熟、稳定、文档丰富、社区庞大，出问题都能很快找到解决的办法，然而它有一个缺点：组网不够灵活。OpenVPN的组网类型要么是点对点，要么是spoke-and-hub（星状），像本次组网，假如各节点均具备双向访问权限，那么将corp设为中心节点，其它四个节点设为分节点，就可以实现整网的互联互通。问题恰恰就在于corp和User2，其中corp只有outbound的权限，无法成为中心节点；User2只具有inbound权限，无法成为分节点。</p>
<p>当然，如果非要用OpenVPN来实现也不是不可能，但是组网结构比较别扭，可将lab设为server，User1、corp和home作为client。接着，在corp和User2之间再创建一条点对点隧道。这种组网结构的配置会比较繁琐，排错困难。而且一旦lab节点宕机，则互联网用户将无法访问User2，既然采用spoke-and-hub的组网方式那么困难，那有没有一种去中心化的VPN组网呢？</p>
<p>有，那就是mesh VPN，tinc、ZeroRouter、hamachi、cloudVPN和socialVPN是其中的代表。经过比较，本项目选择tinc。实际上tinc的诞生已逾10年，同OpenVPN一样基于OpenSSL，不过一直生存在OpenVPN的阴影之下，未被世人知晓。</p>
<p>以下的介绍来自tinc官网：</p>
<p><strong>What is tinc?</strong></p>
<p>tinc is a Virtual Private Network (VPN) daemon that uses tunnelling and encryption to create a secure private network between hosts on the Internet. tinc is Free Software and licensed under the GNU General Public License version 2 or later. Because the VPN appears to the IP level network code as a normal network device, there is no need to adapt any existing software. This allows VPN sites to share information with each other over the Internet without exposing any information to others. In addition, tinc has the following features:</p>
<p><strong>Encryption, authentication and compression</strong><br>All traffic is optionally compressed using zlib or LZO, and OpenSSL is used to encrypt the traffic and protect it from alteration with message authentication codes and sequence numbers.<br><strong>Automatic full mesh routing</strong><br>Regardless of how you set up the tinc daemons to connect to each other, VPN traffic is always (if possible) sent directly to the destination, without going through intermediate hops.<br><strong>Easily expand your VPN</strong><br>When you want to add nodes to your VPN, all you have to do is add an extra configuration file, there is no need to start new daemons or create and configure new devices or network interfaces.<br><strong>Ability to bridge ethernet segments</strong><br>You can link multiple ethernet segments together to work like a single segment, allowing you to run applications and games that normally only work on a LAN over the Internet.<br><strong>Runs on many operating systems and supports IPv6</strong><br>Currently Linux, FreeBSD, OpenBSD, NetBSD, MacOS/X, Solaris, Windows 2000, XP, Vista and Windows 7 and 8 platforms are supported. See our section about supported platforms for more information about the state of the ports. tinc has also full support for IPv6, providing both the possibility of tunneling IPv6 traffic over its tunnels and of creating tunnels over existing IPv6 networks. </p>
<p>我觉得最厉害的功能是<code>automatic full mesh routing</code>和<code>easily expand</code>。 :: top-physical-link ::<br>上图是物理连接，tinc启动后，会自动创建一个full mesh network，无需人工接入。譬如home和corp节点，在通常情况下是无法直接创建隧道的，原因是：</p>
<ol>
<li>我缺乏corp互联网防火墙的控制权，不能开端口映射；</li>
<li>home用的是移动宽带，无法对其它运营商用户开服务；</li>
</ol>
<p>然而借助lab这个中间节点，tinc就可以让corp和home之间直接创建加密隧道，后续的业务流量直接在该隧道中跑了。<br>tinc有路由和交换两种模式，路由模式的效率更高，broadcast被阻断，switch模式更方便，不需要配置网段信息。<br>本项目一共尝试了3种组合，每种组合均有适合的应用场景：</p>
<ol>
<li>路由模式+静态路由</li>
</ol>
<ul>
<li>少量节点，譬如实现公司和家两点的互联；</li>
<li>大量节点，但节点内主机不参与通信，譬如多人联网玩局域网有戏；</li>
</ul>
<ol>
<li>交换模式+动态路由</li>
</ol>
<ul>
<li>大量节点，节点内主机参与通信，同时管理员拥有节点内网的IP地址规划和控制核心路由器的权限；</li>
</ul>
<ol>
<li>路由模式+NAT</li>
</ol>
<ul>
<li>大量节点，节点内主机参与通信，但管理员缺乏或仅拥有少部分节点内网IP地址规划和控制核心路由器的权限；</li>
</ul>
<p>在构建VPN之前，需先普及一下tinc的安装流程。</p>
<h2>tinc安装和调试</h2>
<p>在debian和openwrt中安装tinc非常简单</p>
<h3>安装</h3>
<p><strong>debian</strong></p>
<p><code>aptitude update &amp;&amp; aptitude -t squeeze-backports install tinc</code></p>
<p><strong>openwrt</strong></p>
<p><code>opkg update &amp;&amp; opkg install tinc</code></p>
<p>巧的是，debian squeeze-backports和openwrt 12.09中，tinc的版本均为1.0.19。</p>
<h3>启动</h3>
<p><strong>debian</strong></p>
<p>修改启动参数</p>
<figure class="highlight"><pre><span class="preprocessor"># echo "EXTRA="--debug=3"" &gt; /etc/default/tinc</span>
<span class="preprocessor"># echo "&lt;network id&gt;" &gt;&gt; /etc/tinc/nets.boot</span>
</pre></figure>

<p>说明：</p>
<ol>
<li><p>debian跟其它发行版不同，喜欢在<code>/etc/default</code>中放守护进程的运行参数。默认情况下，tinc的log级别为1，当需要更详细的日志信息时，可以通过EXTRA=“—debug=3”现象来提升级别。日志输出到/var/log/syslog中。也可以通过“—logfile”将log重定向到/var/log/tinc.<network id>.log中，但奇怪的是，tinc仍会将一份log写到/var/log/syslog，可能是一个bug。</p>
</li>
<li><p>debian package还提供了一个<code>/etc/tinc/net.boots</code>的控制文件，当用户需要开启某个vpn进程时，需要将该vpn进程的<code>network id</code>添加到该文件中。</p>
</li>
</ol>
<p><code>/etc/init.d/tinc start</code></p>
<p><strong>openwrt</strong></p>
<p>openwrt package附送了一个tinc.initd的启动脚本，然而只能识别uci配置，由于tinc涉及到的配置文件较多，因而我决定采用文本配置方式，tinc.initd就不适用了，所以还得另行创建一个启动脚本。</p>
<figure class="highlight"><pre><span class="comment"># mv /etc/init.d/tinc /etc/init.d/tinc.orig</span>
<span class="comment"># echo &lt;&lt;'EOF' &gt; /etc/init.d/tinc</span>

<span class="shebang">#!/bin/sh</span> /etc/rc.common

START=46
STOP=46

start() {
        tincd -n &lt;network id&gt; -d3
}

stop() {
        killall tincd
}
EOF
</pre></figure>

<p>说明：全网节点的<code>network id</code>建议保持一致。</p>
<p><code>root@corp:~ # /etc/init.d/tinc enable</code></p>
<p>这就可以实现开机自启动了。</p>
<p>手工启动的命令是<code>/etc/init.d/tinc start</code></p>
<h3>排错</h3>
<ol>
<li>查看tun0网口</li>
</ol>
<p><code># ip addr show tun0</code></p>
<ol>
<li>查看connection</li>
</ol>
<p><code># netstat -atun | grep 655</code></p>
<ol>
<li>查看log</li>
</ol>
<p><code># tail -f /var/log/syslog | grep tinc</code></p>
<ol>
<li>检查对端655端口</li>
</ol>
<p><code># telnet &lt;wan ip&gt; 655</code></p>
<ol>
<li>ping+tcpdump</li>
</ol>
<p><code># tcpdump -nvi tun0 icmp</code></p>
<p>万事俱备，只欠东风，下面开始a mesh vpn network之旅。</p>
<h2>路由+静态路由</h2>
<p>以lab和User1为例，这两个节点均有静态互联网IP，网关均为debian squeeze虚拟机。</p>
<p><strong>lab</strong></p>
<ol>
<li>创建一个network</li>
</ol>
<p><code># mkdir -p /etc/tinc/mgmt/hosts</code></p>
<p>tinc可以同时开启多个vpn进程，每个进程的相关配置存放到一个被称为<code>network id</code>的文件夹中，本文的<code>network id</code>取名为mgmt。</p>
<ol>
<li>生成hosts配置</li>
</ol>
<figure class="highlight lang-bash"><pre><span class="comment"># echo &lt;&lt;'EOF' &gt; /etc/tinc/mgmt/hosts/lab</span>
Address = 221.182.254.165

<span class="comment">## vpn subnet</span>
Subnet = 10.8.0.254/32

<span class="comment">## lab's real subnet</span>
Subnet = 192.168.33.0/24
Subnet = 192.168.66.0/24
EOF
</pre></figure>

<ol>
<li>生成证书</li>
</ol>
<p><code># tincd -n mgmt -K4096</code></p>
<p>tinc将会提示公私钥的存放位置，默认情况下，私钥以独立文件方式存放在<code>/etc/tinc/&lt;network&gt;</code>目录，公钥会附在hosts文件末尾。</p>
<figure class="highlight"><pre><span class="comment">#</span> <span class="comment">cat</span> <span class="comment">/etc/tinc/mgmt/hosts/lab</span>

<span class="comment">Address</span> <span class="comment">=</span> <span class="comment">221</span>.<span class="comment">xx</span>.<span class="comment">xx</span>.<span class="comment">165</span>

<span class="comment">##</span> <span class="comment">vpn</span> <span class="comment">subnet</span>
<span class="comment">Subnet</span> <span class="comment">=</span> <span class="comment">10</span>.<span class="comment">8</span>.<span class="comment">0</span>.<span class="comment">254/32</span>

<span class="comment">##</span> <span class="comment">lab's</span> <span class="comment">real</span> <span class="comment">subnet</span>
<span class="comment">Subnet</span> <span class="comment">=</span> <span class="comment">192</span>.<span class="comment">168</span>.<span class="comment">33</span>.<span class="comment">0/24</span>
<span class="comment">Subnet</span> <span class="comment">=</span> <span class="comment">192</span>.<span class="comment">168</span>.<span class="comment">66</span>.<span class="comment">0/24</span>

<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">BEGIN</span> <span class="comment">RSA</span> <span class="comment">PUBLIC</span> <span class="comment">KEY</span>-<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
<span class="string">.</span><span class="string">.</span><span class="string">.</span>
<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">END</span> <span class="comment">RSA</span> <span class="comment">PUBLIC</span> <span class="comment">KEY</span>-<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
</pre></figure>

<ol>
<li>生成tinc.conf</li>
</ol>
<figure class="highlight"><pre># echo &lt;<span class="xml"><span class="tag">&lt;<span class="title">'EOF'</span> &gt;</span> /etc/tinc/mgmt/tinc.conf
Name = lab
AddressFamily = ipv4
ConnectTo = User1
Interface = tun0
EOF</span>
</pre></figure>

<ol>
<li>创建tinc-up脚本</li>
</ol>
<figure class="highlight lang-bash"><pre><span class="comment"># echo &lt;&lt;'EOF' &gt; /etc/tinc/mgmt/tinc-up</span>
<span class="shebang">#!/bin/sh</span>

User1_VIP=<span class="string">"10.8.0.253"</span>
lab_VIP=<span class="string">"10.8.0.254"</span>

ip link <span class="keyword">set</span> <span class="variable">$INTERFACE</span> up
ip address add dev <span class="variable">$INTERFACE</span> <span class="variable">${lab_VIP}</span>/24

ip route add <span class="variable">$User1_VIP</span> via <span class="variable">$lab_VIP</span>

<span class="comment">## to User1's real subnet</span>
ip route add 10.168.1.0/24 via <span class="variable">$User1_VIP</span>
ip route add 10.168.9.0/24 via <span class="variable">$User1_VIP</span>
ip route add 10.1.0.0/24 via <span class="variable">$User1_VIP</span>
ip route add 10.2.0.0/24 via <span class="variable">$User1_VIP</span>
ip route add 10.3.0.0/16 via <span class="variable">$User1_VIP</span>
ip route add 192.168.200.0/24 via <span class="variable">$User1_VIP</span>
EOF
</pre></figure>

<p>说明：<br>1. OS需添加相关静态路由，tinc才能转发数据包；<br>2. trick：先添加一条点对点路由，然后再将对端网段指向对端网关IP地址；</p>
<p><strong>User1</strong></p>
<ol>
<li>创建hosts文件</li>
</ol>
<figure class="highlight lang-bash"><pre><span class="comment"># echo &lt;&lt;'EOF' &gt; /etc/tinc/mgmt/hosts/User1</span>
Address = 221.xx.xx.44

<span class="comment"># VPN subnet</span>
Subnet = 10.8.0.253/32

<span class="comment"># User1's real subnet</span>
Subnet = 10.168.1.0/24
Subnet = 10.168.9.0/24
Subnet = 10.1.0.0/24
Subnet = 10.2.0.0/24
Subnet = 10.3.0.0/16
Subnet = 192.168.200.0/24
EOF
</pre></figure>

<ol>
<li>生成证书</li>
</ol>
<p><code># tincd -n mgmt</code></p>
<ol>
<li>创建tinc-up脚本</li>
</ol>
<figure class="highlight lang-bash"><pre>root@User1:~ <span class="comment"># echo &lt;&lt;'EOF' &gt; /etc/tinc/mgmt/tinc-up</span>
<span class="shebang">#!/bin/sh</span>

User1_VIP=<span class="string">"10.8.0.253"</span>
lab_VIP=<span class="string">"10.8.0.254"</span>

ip link <span class="keyword">set</span> <span class="variable">$INTERFACE</span> up
ip address add dev <span class="variable">$INTERFACE</span> <span class="variable">${User1_VIP}</span>/24

ip route add <span class="variable">$lab_VIP</span> via <span class="variable">$User1_VIP</span>

<span class="comment"># to lab's real subnet</span>
ip route add 192.168.33.0/24 via <span class="variable">$lab_VIP</span>
ip route add 192.168.55.0/24 via <span class="variable">$lab_VIP</span>
ip route add 192.168.66.0/24 via <span class="variable">$lab_VIP</span>
ip route add 192.168.88.0/24 via <span class="variable">$lab_VIP</span>
EOF
</pre></figure>

<p>在启动前，需要把hosts文件分别拷贝到对方的hosts目录下：</p>
<p><code>root@User1:~ # scp /etc/tinc/mgmt/hosts/User1 lab_host_ip:/etc/tinc/mgmt/hosts</code></p>
<p><code>root@lab:~ # scp /etc/tinc/mgmt/hosts/lab User1_host_ip:/etc/tinc/mgmt/hosts</code></p>
<p>最后，分别启动tinc</p>
<p><code>root@lab:~ # /etc/init.d/tinc start</code></p>
<p><code>root@User1:~ # /etc/init.d/tinc start</code></p>
<p>这样就在lab和User1之间创建了一条加密隧道，非常简单。</p>
<p>路由+静态路由模式的一个缺陷就是，随着节点的增多，需要手工配置的路由越来越多，维护工作量也越来越大。下面是<code>corp</code>节点的<code>tinc-up</code></p>
<figure class="highlight lang-bash"><pre>root@corp:~ <span class="comment"># cat /etc/tinc/mgmt/tinc-up</span>
<span class="comment">#!/usr/sh</span>
home_VIP=<span class="string">"10.8.0.250"</span>
User1_VIP=<span class="string">"10.8.0.253"</span>
User2_VIP=<span class="string">"10.8.0.251"</span>
corp_VIP=<span class="string">"10.8.0.252"</span>
lab_VIP=<span class="string">"10.8.0.254"</span>

ip link <span class="keyword">set</span> <span class="variable">$INTERFACE</span> up
ip address add dev <span class="variable">$INTERFACE</span> <span class="variable">${corp_VIP}</span>/24

ip route add <span class="variable">$User1_VIP</span> via <span class="variable">$corp_VIP</span>
ip route add <span class="variable">$lab_VIP</span> via <span class="variable">$corp_VIP</span>
ip route add <span class="variable">$User2_VIP</span> via <span class="variable">$corp_VIP</span>
ip route add <span class="variable">$home_VIP</span> via <span class="variable">$corp_VIP</span>


<span class="comment"># to User1's real subnet</span>
ip route add 10.168.1.0/24 via <span class="variable">$User1_VIP</span>
ip route add 10.168.9.0/24 via <span class="variable">$User1_VIP</span>
ip route add 10.1.0.0/24 via <span class="variable">$User1_VIP</span>
ip route add 10.2.0.0/24 via <span class="variable">$User1_VIP</span>
ip route add 10.3.0.0/16 via <span class="variable">$User1_VIP</span>
ip route add 192.168.200.0/24 via <span class="variable">$User1_VIP</span>

<span class="comment"># to lab's real subnet</span>
ip route add 192.168.33.0/24 via <span class="variable">$lab_VIP</span>
ip route add 192.168.55.0/24 via <span class="variable">$lab_VIP</span>
ip route add 192.168.66.0/24 via <span class="variable">$lab_VIP</span>
ip route add 192.168.88.0/24 via <span class="variable">$lab_VIP</span>

<span class="comment"># to User2's real subnet</span>
ip route add 10.10.115.0/24 via <span class="variable">$User2_VIP</span>
ip route add 10.10.80.0/24 via <span class="variable">$User2_VIP</span>
ip route add 10.10.84.0/24 via <span class="variable">$User2_VIP</span>
ip route add 10.10.88.0/24 via <span class="variable">$User2_VIP</span>

<span class="comment"># to home's real subnet</span>
ip route add 192.168.22.0/24 via <span class="variable">$home_VIP</span>
</pre></figure>

<p>这还不算完，各节点的核心路由器也要添加相应的静态路由<strong>脚注2</strong>，它们的内网方能互相通信。这就不能忍了，之所以抛弃OpenVPN而选择tinc，不就是看到它自我标榜的<code>easily expand</code>吗？怎么办呢？上动态路由吧。</p>
<h2>交换+动态路由</h2>
<p>嗯，这又是一个庞大的话题。我对动态路由的认识远在2005年，考完CCNP后就丢掉了。因而，本章就不误人子弟了，只有简单的说明，技术细节请自行参考cisco出的通俗读物。</p>
<p>现在，我们需要在所有节点网关上跑动态路由协议，它们之间互相协商，根据链路的通断动态调整路由指向，最后形成一张（某个路由器）临时路由表。有了这个功能，我们就不需要再手工维护路由表了，just leave them alone。</p>
<h3>tinc配置</h3>
<p>引入动态路由后，tinc-up的配置得到极大的简化：</p>
<p><strong>lab</strong></p>
<figure class="highlight lang-bash"><pre>root@lab:~ <span class="comment"># cat /etc/tinc/mgmt/tinc-up</span>
<span class="shebang">#!/bin/sh</span>
ip link <span class="keyword">set</span> <span class="variable">$INTERFACE</span> up
ip address add dev <span class="variable">$INTERFACE</span> 10.8.0.254
</pre></figure>

<p><strong>corp</strong></p>
<figure class="highlight lang-bash"><pre>root@corp:~ <span class="comment"># cat /etc/tinc/mgmt/tinc-up</span>
<span class="shebang">#!/bin/sh</span>
ip link <span class="keyword">set</span> <span class="variable">$INTERFACE</span> up
ip address add dev <span class="variable">$INTERFACE</span> <span class="variable">$10</span>.8.0.252
</pre></figure>

<p>然而，引入动态路由后，<code>tinc.conf</code>还需要手工添加<code>Subnet=本节点内网</code>，各节点之间才能正常的通信。解决办法是将tinc的组网模式需要从router变更为switch（在<code>tinc.conf</code>中添加<code>Mode = switch</code>），switch的性能比route要差一些，因为还要处理broadcast和arp请求等数据包，但是可以不用再费心去维护各节点的子网信息了。以一点性能损失来换取维护的便利还是值得的。</p>
<p>全部节点的<code>tinc.conf</code>和<code>tinc-up</code>都得到简化，顿时感觉清爽了不少，真正做到leave them alone！</p>
<h3>动态路由</h3>
<p>动态路由包含路由平台和动态路由协议。路由平台运行在linux服务器上，而动态路由协议则运行在路由平台上，可以将运行着路由平台的服务器看作一台路由器。</p>
<h4>选择</h4>
<p>每次选择开源软件都很真痛苦，因为不知道选中的软件能活多久。譬如我之前为n2n歌功颂德，没几天，作者就说没时间维护，请关注fork，这不是坑爹吗？幸好开源的路由平台也没有太多的选择：quagga or bird。10年前曾试过zebra，稳定性实在太差，所以对quagga也不太感冒，加上bird已经在欧洲多个Internet exchanger部署，所以就选了bird。bird目前仅支持传统的RIP、BGP、OSPF，尚不支持babel、olsr等mesh network协议，因而路由协议就选了ospf，没有选择也是一种幸福。</p>
<h4>安装</h4>
<p><strong>debian</strong></p>
<p><code>aptitude update &amp;&amp; aptitude -t squeeze-backports install bird</code></p>
<p><strong>openwrt</strong></p>
<p><code>opkg update &amp;&amp; opkg install bird4 birdc4</code></p>
<h4>配置</h4>
<p>这里以<code>lab</code>和<code>corp</code>为例：</p>
<p><strong>lab</strong></p>
<figure class="highlight lang-bash"><pre>root@root@lab:~ <span class="comment"># cat /etc/bird.conf</span>
log syslog { debug, trace, info, remote, warning, error, auth, fatal, bug };
router id 10.8.0.254;
debug protocols all;

protocol kernel {
        persist;                <span class="comment"># Don't remove routes on bird shutdown</span>
        scan time 20;           <span class="comment"># Scan kernel routing table every 20 seconds</span>
        export all;             <span class="comment"># Default is export none</span>
}

protocol device {
        scan time 10;           <span class="comment"># Scan interfaces every 10 seconds</span>
}

protocol direct {
        interface <span class="string">"eth0"</span>;
}

protocol static {
       debug all;
}

protocol ospf {
        import all;
        export all;
        area 0.0.0.0 {
                interface <span class="string">"tun0"</span> {
                        hello 9;
                        retransmit 6;
                        cost 10;
                        transmit delay 5;
                        dead count 60;
                        wait 10;
                        type pointopoint;
                };
        };
}
</pre></figure>

<p><strong>corp</strong></p>
<p>bird的配置与lab几乎一致，区别是</p>
<figure class="highlight"><pre>route <span class="keyword">id</span> <span class="number">10.8</span><span class="number">.0</span><span class="number">.252</span>;
<span class="class"><span class="keyword">protocol</span> <span class="id">direct</span> {</span>
        <span class="class"><span class="keyword">interface</span> "<span class="id">br</span>-<span class="id">lan</span>", "<span class="id">wlan0</span>";</span>
}
</pre></figure>

<p>protocol direct的意思是将直连路由塞入ospf中参与协商，换句话说，通告给相连路由器，我这里有192.168.44.0/24和192.168.77.0/24这两个子网，请将目标地址属于这两个子网的数据包丢过来给我处理吧。</p>
<h4>常用指令</h4>
<p><strong>启动</strong></p>
<p>debian：<code># /etc/init.d/bird start</code></p>
<p>openwrt：<code># /etc/init.d/bird4 start</code></p>
<p><strong>自启动</strong></p>
<p>debian：<code># /etc/init.d/bird enable</code></p>
<p>openwrt：<code># /etc/init.d/bird4 enable</code></p>
<p><strong>查看状态</strong></p>
<p>可以通过birdc/birdc4来查看bird平台状态</p>
<figure class="highlight"><pre>root@corp:~<span class="comment"># birdc4 </span>
BIRD <span class="number">1.3</span><span class="number">.7</span> ready.
bird&gt; show route
<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>          via <span class="number">10.8</span><span class="number">.0</span><span class="number">.251</span> <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> [ospf1 Jul29] ! E2 (<span class="number">150</span>/<span class="number">10</span>/<span class="number">10000</span>) [<span class="number">10.8</span><span class="number">.0</span><span class="number">.251</span>]
<span class="number">10.2</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span>        via <span class="number">10.8</span><span class="number">.0</span><span class="number">.253</span> <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> [ospf1 Jul28] * E2 (<span class="number">150</span>/<span class="number">10</span>/<span class="number">10000</span>) [<span class="number">10.8</span><span class="number">.0</span><span class="number">.253</span>]
<span class="number">10.3</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span>        via <span class="number">10.8</span><span class="number">.0</span><span class="number">.253</span> <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> [ospf1 Jul28] * E2 (<span class="number">150</span>/<span class="number">10</span>/<span class="number">10000</span>) [<span class="number">10.8</span><span class="number">.0</span><span class="number">.253</span>]
<span class="number">172.168</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span>     via <span class="number">10.8</span><span class="number">.0</span><span class="number">.251</span> <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> [ospf1 Jul29] * E2 (<span class="number">150</span>/<span class="number">10</span>/<span class="number">10000</span>) [<span class="number">10.8</span><span class="number">.0</span><span class="number">.251</span>]
<span class="number">10.1</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span>        via <span class="number">10.8</span><span class="number">.0</span><span class="number">.253</span> <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> [ospf1 Jul28] * E2 (<span class="number">150</span>/<span class="number">10</span>/<span class="number">10000</span>) [<span class="number">10.8</span><span class="number">.0</span><span class="number">.253</span>]
<span class="number">10.10</span><span class="number">.10</span><span class="number">.0</span>/<span class="number">24</span>      via <span class="number">10.8</span><span class="number">.0</span><span class="number">.253</span> <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> [ospf1 Jul28] * E2 (<span class="number">150</span>/<span class="number">10</span>/<span class="number">10000</span>) [<span class="number">10.8</span><span class="number">.0</span><span class="number">.253</span>]
<span class="number">10.8</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span>        dev tun0 [ospf1 Jul28] * I (<span class="number">150</span>/<span class="number">10</span>) [<span class="number">10.8</span><span class="number">.0</span><span class="number">.252</span>]
<span class="number">192.168</span><span class="number">.77</span><span class="number">.0</span>/<span class="number">24</span>    dev wlan0 [direct1 Jul28] * (<span class="number">240</span>)
<span class="number">192.168</span><span class="number">.33</span><span class="number">.0</span>/<span class="number">24</span>    via <span class="number">10.8</span><span class="number">.0</span><span class="number">.254</span> <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> [ospf1 Jul29] * E2 (<span class="number">150</span>/<span class="number">10</span>/<span class="number">10000</span>) [<span class="number">10.8</span><span class="number">.0</span><span class="number">.254</span>]
<span class="number">192.168</span><span class="number">.44</span><span class="number">.0</span>/<span class="number">24</span>    dev br-lan [direct1 Jul28] * (<span class="number">240</span>)
<span class="number">10.10</span><span class="number">.115</span><span class="number">.0</span>/<span class="number">25</span>     via <span class="number">10.8</span><span class="number">.0</span><span class="number">.251</span> <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> [ospf1 Jul29] * E2 (<span class="number">150</span>/<span class="number">10</span>/<span class="number">10000</span>) [<span class="number">10.8</span><span class="number">.0</span><span class="number">.251</span>]
<span class="number">10.10</span><span class="number">.80</span><span class="number">.0</span>/<span class="number">24</span>      via <span class="number">10.8</span><span class="number">.0</span><span class="number">.251</span> <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> [ospf1 Jul29] ! E2 (<span class="number">150</span>/<span class="number">10</span>/<span class="number">10000</span>) [<span class="number">10.8</span><span class="number">.0</span><span class="number">.251</span>]
<span class="number">10.10</span><span class="number">.84</span><span class="number">.0</span>/<span class="number">24</span>      via <span class="number">10.8</span><span class="number">.0</span><span class="number">.251</span> <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> [ospf1 Jul29] ! E2 (<span class="number">150</span>/<span class="number">10</span>/<span class="number">10000</span>) [<span class="number">10.8</span><span class="number">.0</span><span class="number">.251</span>]
<span class="number">10.10</span><span class="number">.88</span><span class="number">.0</span>/<span class="number">24</span>      via <span class="number">10.8</span><span class="number">.0</span><span class="number">.251</span> <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> [ospf1 Jul29] ! E2 (<span class="number">150</span>/<span class="number">10</span>/<span class="number">10000</span>) [<span class="number">10.8</span><span class="number">.0</span><span class="number">.251</span>]
<span class="number">10.168</span><span class="number">.9</span><span class="number">.0</span>/<span class="number">24</span>      via <span class="number">10.8</span><span class="number">.0</span><span class="number">.253</span> <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> [ospf1 Jul28] * E2 (<span class="number">150</span>/<span class="number">10</span>/<span class="number">10000</span>) [<span class="number">10.8</span><span class="number">.0</span><span class="number">.253</span>]
<span class="number">10.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span>      via <span class="number">10.8</span><span class="number">.0</span><span class="number">.253</span> <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> [ospf1 Jul28] * E2 (<span class="number">150</span>/<span class="number">10</span>/<span class="number">10000</span>) [<span class="number">10.8</span><span class="number">.0</span><span class="number">.253</span>]
bird&gt;<span class="keyword">exit</span>
</pre></figure>

<p>再用<code>ip route show</code>查看，就会发现bird已经将路由写入到kernel路由表中了，每条路由后面带有<code>proto bird</code>的后缀。需要说明的是，手工设置的路由优先级最高，bird无法覆盖。</p>
<p><strong>log</strong></p>
<p><code>tail -f /var/log/syslog | grep bird</code></p>
<p>动态路由的引入极大地拓展tinc的应用场景，譬如在全国拥有大量分支机构的企业，就可以利用“交换+动态路由”模式在互联网上构建一张灵活的full mesh network。当然，tinc+动态路由并非万能，需满足以下条件：</p>
<ol>
<li>各节点的IP地址段统一分配；</li>
<li>各节点内网的核心路由器/交换机也需开启动态路由协议。</li>
</ol>
<p>否则会出现：</p>
<ol>
<li>节点的IP地址段容易冲突；</li>
<li>各节点核心路由器/交换机的路由表需手工维护，工作量大<strong>脚注2</strong>；</li>
</ol>
<p>在本项目中，corp、User1、User2的网络规划和网络设备都不归我负责，故动态路由注定只是匆匆过客。虽然它的出现给tinc带来了无限的可能，但此时我只能无情地say no，重新寻找新的解决方案。不久，NAT在不经意中出现了，欲知后事，详见下一章节“路由+NAT”。</p>
<h2>路由+NAT</h2>
<p>上一章节中提到希望通过NAT的方式来“解决IP地址冲突”和“缓解节点核心路由器路由表维护工作”这两个问题，其思路是：</p>
<p>将一个C类（10.8.0.0/24）切割成多个子网段，每个分节点分配一个子网段，子网段的第一个可用IP地址作为该节点的互联IP地址，剩余的以1:1 NAT方式映射至节点内主机。</p>
<p>假设vpn地址分配&amp;映射表如下：</p>
<p>:: vpn地址分配&amp;映射表 ::</p>
<p>lab：10.8.0.0/27<br>User1: 10.8.0.32/27<br>corp: 10.8.0.64/27<br>User2: 10.8.0.96/27<br>home: 10.8.0.128/27</p>
<p>下面以lab:monitor与User2:storage之间的通信为例，monitor和storage的IP地址处于冲突状态，原本无法相互通信。</p>
<p>lab:monitor -&gt; User2:storage</p>
<p>数据包IP层为src ip: 192.168.33.78/dst ip: 10.8.0.97，当数据包经过lab网关时，src ip被替换成10.8.0.2，当数据包到达User2网关时，dst ip被替换成10.10.115.3，数据包IP层变成了src ip: 10.8.0.2/dst ip: 192.168.33.78，最后达到storage；</p>
<p>User2:storage -&gt; lab:monitor</p>
<p>数据包IP层为src ip: 10.8.0.2/dst ip: 192.168.33.78，当数据包经过User2网关时，src ip被替换成10.8.0.97，当数据包达到lab网关时，dst ip被替换成192.168.33.68，数据包IP层变成了src ip: 10.8.0.97/dst ip: 192.168.33.78，最后达到monitor；</p>
<p>使用1:1 NAT技术后，</p>
<ol>
<li>在vpn中，源和目标地址均为10.8.0.0/24，充分利用了tinc的<code>auto routing</code>功能特性，实现tinc vpn的路由不需要配置路由；</li>
<li>在节点内，核心路由器只需要配置一条静态路由，将10.8.0.0/24指向本节点网关的内网IP即可。</li>
</ol>
<p>也就是说，<br>利用1:1 NAT技术可以实现：</p>
<ol>
<li>规避节点内网路由；</li>
<li>规避各节点内网段的冲突问题；</li>
<li>减轻节点内的核心路由器路由表的维护工作；</li>
<li></li>
</ol>
<p>1:1 NAT是节点网关的第一个功能需求，第二个功能需求则是实现以下的安全访问策略：</p>
<p><strong>“corp”节点</strong></p>
<ul>
<li>允许节点内主机访问互联网；</li>
<li>允许“User2”节点网关访问本节点网关的DNS服务，并通过本节点访问互联网；</li>
<li>开启“User1”、“User2”、“lab”、“home”之间的路由转发功能；</li>
</ul>
<p><strong>“home”节点</strong></p>
<ul>
<li>允许终端访问“lab”、“lab”、“User1”和“User2”节点的内部网段；</li>
</ul>
<p><strong>“lab”节点</strong></p>
<ul>
<li>允许“home”、“corp”访问节点网关SSH、web服务；</li>
<li>允许“home”、“corp”访问节点内网的所有服务；</li>
<li>终端可以自由的访问“User1”和“User2”的内部网段；</li>
</ul>
<p><strong>“User2”节点</strong></p>
<ul>
<li>允许“lab”、“corp”和“home”特定主机访问节点内网的SSH、web服务；</li>
<li>允许本节点网关访问“corp”节点的DNS服务；</li>
<li>允许本节点网关通过“corp”节点访问互联网，用于软件升级；</li>
</ul>
<p><strong>“User1”节点</strong></p>
<ul>
<li>允许“lab”、“corp”和“home”特定主机访问节点内网的SSH、web服务；</li>
</ul>
<p><strong>所有节点</strong></p>
<ul>
<li>允许节点网关之间互ping；</li>
</ul>
<p>毫无疑问，需要在各节点启用iptables/netfilter，但自从用了pf后，我对iptables的语法深恶痛绝，故在debian安装了shorewall，OpenWRT则用了的shorewall-lite。</p>
<p>在玩弄防火墙之前，还是先调整tinc的配置。</p>
<h3>tinc配置</h3>
<p><strong>lab</strong></p>
<p>tinc需要修改两个地方：</p>
<ol>
<li>/etc/tinc/mgmt/hosts/lab</li>
</ol>
<figure class="highlight"><pre><span class="comment">Address</span> <span class="comment">=</span> <span class="comment">221</span>.<span class="comment">xx</span>.<span class="comment">xx</span>.<span class="comment">165</span>

<span class="comment">#</span> <span class="comment">VPN</span> <span class="comment">subnet</span>
<span class="comment">Subnet</span> <span class="comment">=</span> <span class="comment">10</span>.<span class="comment">8</span>.<span class="comment">0</span>.<span class="comment">0/27</span>

<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">BEGIN</span> <span class="comment">RSA</span> <span class="comment">PUBLIC</span> <span class="comment">KEY</span>-<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
<span class="string">.</span><span class="string">.</span><span class="string">.</span>
<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">END</span> <span class="comment">RSA</span> <span class="comment">PUBLIC</span> <span class="comment">KEY</span>-<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
</pre></figure>

<ol>
<li>/etc/tinc/mgmt/tinc.conf</li>
</ol>
<figure class="highlight"><pre><span class="keyword">...</span>
<span class="comment"># Mode = switch</span>
</pre></figure>

<p>将Mode由switch恢复为route，tinc会自动将目标地址为10.8.0.0/27网段丢到10.8.0.1。</p>
<p><strong>corp</strong></p>
<p>tinc需要修改两个地方：</p>
<ol>
<li>/etc/tinc/mgmt/hosts/lab</li>
</ol>
<figure class="highlight"><pre><span class="comment">Address</span> <span class="comment">=</span> <span class="comment">221</span>.<span class="comment">xx</span>.<span class="comment">xx</span>.<span class="comment">165</span>

<span class="comment">#</span> <span class="comment">VPN</span> <span class="comment">subnet</span>
<span class="comment">Subnet</span> <span class="comment">=</span> <span class="comment">10</span>.<span class="comment">8</span>.<span class="comment">0</span>.<span class="comment">0/27</span>

<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">BEGIN</span> <span class="comment">RSA</span> <span class="comment">PUBLIC</span> <span class="comment">KEY</span>-<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
<span class="string">.</span><span class="string">.</span><span class="string">.</span>
<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">END</span> <span class="comment">RSA</span> <span class="comment">PUBLIC</span> <span class="comment">KEY</span>-<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
</pre></figure>

<ol>
<li>/etc/tinc/mgmt/tinc.conf</li>
</ol>
<figure class="highlight"><pre><span class="keyword">...</span>
<span class="comment"># Mode = switch</span>
</pre></figure>

<h3>防火墙</h3>
<p>下面分别以lab和corp为例说明debian shorewall和OpenWRT shorewall-lite的安装和配置。</p>
<p>shorewall主要是要理解zones，policy和rules，具体的就不献丑了，官网文档很详尽。另外，为了更好的排错，我用ulogd替代了syslog，默认情况下，netfilter利用syslog来记录，一是效率低，二是跟<code>/var/log/syslog</code>混在一起，改用ulogd后效率更高，而且可以将日志存放在单独的文件中。</p>
<h4>shorewall on debian</h4>
<h5>安装</h5>
<figure class="highlight"><pre>root<span class="variable">@lab</span><span class="symbol">:~</span> <span class="comment"># echo "" &gt;&gt; /etc/apt/sources.list</span>
root<span class="variable">@lab</span><span class="symbol">:~</span> <span class="comment"># aptitude update && aptitude install shorewall ulogd</span>
</pre></figure>

<h5>配置</h5>
<p>/etc/default/shorewall</p>
<figure class="highlight"><pre>startup=<span class="number">1</span>
<span class="keyword">...</span>
</pre></figure>

<p>shorewall.conf</p>
<figure class="highlight"><pre><span class="comment"># 修改以下参数：</span>
LOGFILE=/var/log/ulog/syslogemu.log
LOGFORMAT=<span class="string">""</span>
<span class="comment"># 将所有info替换成$LOG</span>

<span class="keyword">...</span>
</pre></figure>

<p>/etc/shorewall/params</p>
<figure class="highlight"><pre><span class="setting">INT_IF=<span class="value">eth0</span></span>
<span class="setting">VPN_IF=<span class="value">tun0</span></span>
<span class="setting">LOG=<span class="value">ULOG</span></span>
</pre></figure>

<p>/etc/shorewall/zones</p>
<figure class="highlight"><pre><span class="title">fw</span>      firewall
<span class="title">net</span>     ipv4
<span class="title">vpn</span>     ipv4
</pre></figure>

<p>/etc/shorewall/interfaces</p>
<figure class="highlight"><pre><span class="title">net</span>     <span class="variable">$INT_IF</span>            dhcp,tcpflags,logmartians,nosmurfs,sourceroute=<span class="number">0</span>
vpn     <span class="variable">$VPN_IF</span>            dhcp,tcpflags,logmartians,nosmurfs,sourceroute=<span class="number">0</span>
</pre></figure>

<p>/etc/shorewall/policy</p>
<figure class="highlight"><pre><span class="variable">$FW</span>             net             ACCEPT
<span class="variable">$FW</span>             vpn             ACCEPT
vpn             <span class="variable">$FW</span>             ACCEPT
net             all             DROP            <span class="variable">$LOG</span>
all             all             REJECT          <span class="variable">$LOG</span>
</pre></figure>

<p>/etc/shorewall/rules</p>
<figure class="highlight"><pre><span class="comment">###############</span>
<span class="comment"># net2fw</span>

<span class="comment"># allow ssh,http,https,655,80,2003 from net to $FW</span>
<span class="title">ACCEPT</span>          net             <span class="variable">$FW</span>             tcp             ssh,http,https,<span class="number">2003</span> 
ACCEPT          net             <span class="variable">$FW</span>             udp,tcp         <span class="number">655</span>

<span class="comment">###############</span>
<span class="comment"># vpn2net</span>

<span class="comment"># allow ssh,http from USER1 to LAB </span>
ACCEPT     vpn:<span class="number">10.8.0.32</span>/<span class="number">27</span>     net:<span class="number">192.168.33.0</span>/<span class="number">24</span>,<span class="number">192.168.66.0</span>/<span class="number">24</span>  tcp     ssh,http

<span class="comment"># allow all from CORP to LAB</span>
ACCEPT          vpn:<span class="number">10.8.0.64</span>/<span class="number">27</span>        net:<span class="number">192.168.33.0</span>/<span class="number">24</span>     all     
ACCEPT          vpn:<span class="number">10.8.0.64</span>/<span class="number">27</span>        net:<span class="number">192.168.55.0</span>/<span class="number">24</span>     all     
ACCEPT          vpn:<span class="number">10.8.0.64</span>/<span class="number">27</span>        net:<span class="number">192.168.66.0</span>/<span class="number">24</span>     all     
ACCEPT          vpn:<span class="number">10.8.0.64</span>/<span class="number">27</span>        net:<span class="number">192.168.88.0</span>/<span class="number">24</span>     all     
ACCEPT          vpn:<span class="number">10.8.0.64</span>/<span class="number">27</span>        net:<span class="number">192.168.100.0</span>/<span class="number">24</span>    all     
ACCEPT          vpn:<span class="number">10.8.0.64</span>/<span class="number">27</span>        net:<span class="number">172.16.33.0</span>/<span class="number">24</span>      all     

<span class="comment">###############</span>
<span class="comment"># net2vpn</span>

ACCEPT  net:<span class="number">192.168.33.0</span>/<span class="number">24</span>     vpn     all
ACCEPT  net:<span class="number">192.168.66.0</span>/<span class="number">24</span>     vpn     all
ACCEPT  net:<span class="number">10.5.1.0</span>/<span class="number">24</span>         vpn     all
ACCEPT  net:<span class="number">172.16.33.0</span>/<span class="number">24</span>      vpn     all

<span class="comment">###############</span>
<span class="comment"># all2all</span>

Ping(ACCEPT)   all             all
</pre></figure>

<p>/etc/shorewall/nat</p>
<figure class="highlight"><pre>10.8.0.2       tun0            192.168.33.231     No               No
10.8.0.3       tun0            192.168.33.232     No               No
10.8.0.4       tun0            192.168.33.233     No               No
10.8.0.5       tun0            192.168.33.234     No               No
10.8.0.6       tun0            192.168.66.21      No               No
10.8.0.7       tun0            192.168.66.22      No               No
10.8.0.8       tun0            192.168.66.23      No               No
10.8.0.9       tun0            192.168.55.120     No               No
10.8.0.10      tun0            192.168.88.120     No               No
</pre></figure>

<figure class="highlight"><pre>root<span class="variable">@lab</span><span class="symbol">:~</span> <span class="comment"># shorewall check</span>
root<span class="variable">@lab</span><span class="symbol">:~</span> <span class="comment"># shorewall restart</span>
root<span class="variable">@lab</span><span class="symbol">:~</span> <span class="comment"># /etc/init.d/ulogd start</span>
</pre></figure>

<p>切记，别把自己关在外面，希望我的提醒还不至于太晚，hoho。</p>
<h4>　shorewall-lite on OpenWRT</h4>
<p>shorewall依赖于perl，对于OpenWRT来说太庞大了。此外，假如有多个防火墙，则需要一套机制进行统一管理，于是诞生了shorewall-lite。</p>
<p>今天，我们就在OpenWRT上体验一下shorewall-lite的魔力。<br>图片</p>
<p>admin(administrative system)安装了shorewall，firewall的配置文件均在admin中完成，随后通过shorewall compile来生成脚本，接着通过scp将该脚本拷贝至firewall的/etc/shorewall-lite/state目录，然后使用ssh远程执行firewall的shorewall-lite，将脚本转换成iptables rules。</p>
<p>这就是shorewall-lite的运作原理。</p>
<p>所以，首先安装admin的shorewall</p>
<p>root@shorewall-centre-d6:/ # apt-get update &amp;&amp; apt-get install shorewall</p>
<pre><code>* 为每个firewall创建一个<span class="keyword">export</span>目录</code></pre>
<p>root@shorewall-centre-d6:/ # make -p export/rb450g &amp;&amp; cd export/rb450g</p>
<pre><code><span class="bullet">* </span>准备firewall配置文件</code></pre>
<p>对于debian系，需下载tarball，解压后将/usr/share/shorewall/configfiles中的文件拷贝至export目录。</p>
<pre><code><span class="bullet">* </span>调整firewall配置文件</code></pre>
<p>拷贝过来的配置文件均是空文件，需要自行调整配置。</p>
<p>/etc/shorewall/export/rb450g/params</p>
<figure class="highlight"><pre><span class="setting">WAN_IF=<span class="value">eth0</span></span>
<span class="setting">LAN_IF=<span class="value">br-lan</span></span>
<span class="setting">OA_IF=<span class="value">br-oa</span></span>
<span class="setting">VPN_IF=<span class="value">tun0</span></span>
<span class="setting">LOG=<span class="value">ULOG</span></span>
</pre></figure>

<p>/etc/shorewall/export/rb450g/zones</p>
<figure class="highlight"><pre><span class="title">fw</span>      firewall
<span class="title">oa</span>      ipv4
<span class="title">lan</span>     ipv4
<span class="title">wan</span>     ipv4
<span class="title">vpn</span>     ipv4
</pre></figure>

<p>/etc/shorewall/export/rb450g/interfaces</p>
<figure class="highlight"><pre><span class="title">wan</span>             <span class="variable">$WAN_IF</span>                 dhcp,tcpflags,logmartians,nosmurfs,sourceroute=<span class="number">0</span>
lan             <span class="variable">$LAN_IF</span>                 tcpflags,logmartians,nosmurfs,sourceroute=<span class="number">0</span>
vpn             <span class="variable">$VPN_IF</span>                 tcpflags,logmartians,nosmurfs,sourceroute=<span class="number">0</span>
oa              <span class="variable">$OA_IF</span>                  tcpflags,logmartians,nosmurfs,sourceroute=<span class="number">0</span>
</pre></figure>

<p>/etc/shorewall/export/rb450g/policy</p>
<figure class="highlight"><pre>$FW     <span class="keyword">all</span>     ACCEPT
lan     <span class="keyword">all</span>     ACCEPT
wan     <span class="keyword">all</span>     DROP            $LOG    <span class="number">10</span>/sec:<span class="number">40</span>
<span class="keyword">all</span>     <span class="keyword">all</span>     <span class="keyword">REJECT</span>
</pre></figure>

<p>/etc/shorewall/export/rb450g/rules</p>
<figure class="highlight"><pre><span class="title">SECTION</span> NEW
Invalid(DROP)   wan             all

<span class="comment">###############</span>
<span class="comment"># vpn2fw</span>

Ping(ACCEPT)    vpn             <span class="variable">$FW</span>
SSH(ACCEPT)     vpn             <span class="variable">$FW</span>
HTTP(ACCEPT)    vpn             <span class="variable">$FW</span>

<span class="comment">###############</span>
<span class="comment"># wan2fw</span>

ACCEPT          wan             <span class="variable">$FW</span>     tcp     <span class="number">655</span>
ACCEPT          wan             <span class="variable">$FW</span>     udp     <span class="number">655</span>
SSH(ACCEPT)     wan             <span class="variable">$FW</span>
</pre></figure>

<p>/etc/shorewall/export/rb450g/masq</p>
<figure class="highlight"><pre><span class="variable">$OA_IF</span>          192.168.44.0/24 10.199.27.17
<span class="variable">$VPN_IF</span>         192.168.44.0/24 10.8.0.65
<span class="variable">$WAN_IF</span>         192.168.44.0/24 192.168.7.21
</pre></figure>

<p>OpenWRT的准备工作</p>
<p>创建<code>state</code></p>
<p>root@RB450G:/ # mkdir /etc/shorewall-lite/state</p>
<p>禁用firewall。</p>
<figure class="highlight lang-bash"><pre>root@RB450G:/ <span class="comment"># /etc/init.d/firewall disable</span>
root@RB450G:/ <span class="comment"># /etc/init.d/firewall stop</span>
</pre></figure>

<p>启用shorewall-lite</p>
<figure class="highlight lang-bash"><pre>root@RB450G:/<span class="comment"># /etc/init.d/shorewall-lite enable</span>
</pre></figure>

<pre><code><span class="bullet">* </span>生成firewall脚本</code></pre>
<p>虽然可用<code>shorewall compile</code>来生成firewall脚本，然而Thomas M. Eastep自己写了个Makefile，然后通过<code>make</code>和<code>make install</code>这两个linux管理员耳熟能详的指令来编译和部署。</p>
<p>root@shorewall-centre-d6:/etc/shorewall/export/rb450g# wget <a href="http://www1.shorewall.net/pub/shorewall/contrib/Shorewall-lite/" target="_blank">http://www1.shorewall.net/pub/shorewall/contrib/Shorewall-lite/</a></p>
<p>然后调整Makefile中的HOST，域名和IP地址均可。若用域名，则需要确保可以解析。</p>
<figure class="highlight lang-bash"><pre>root@shorewall-centre-d6:/etc/shorewall/export/rb450g<span class="comment"># make</span>
shorewall compile -e . firewall
Compiling...
Processing /etc/shorewall/export/rb450g/params ...
Processing /etc/shorewall/export/rb450g/shorewall.conf...
   WARNING: Your capabilities file is out of date -- it does not contain all of the capabilities defined by Shorewall version 4.5.5.3
Compiling /etc/shorewall/export/rb450g/zones...
Compiling /etc/shorewall/export/rb450g/interfaces...
Determining Hosts <span class="keyword">in</span> Zones...
Locating Action Files...
Compiling /usr/share/shorewall/action.Drop <span class="keyword">for</span> chain Drop...
Compiling /usr/share/shorewall/action.Broadcast <span class="keyword">for</span> chain Broadcast...
Compiling /usr/share/shorewall/action.Invalid <span class="keyword">for</span> chain Invalid...
Compiling /usr/share/shorewall/action.NotSyn <span class="keyword">for</span> chain NotSyn...
Compiling /usr/share/shorewall/action.Reject <span class="keyword">for</span> chain Reject...
Compiling /etc/shorewall/export/rb450g/policy...
Compiling /etc/shorewall/export/rb450g/notrack...
Running /etc/shorewall/export/rb450g/initdone...
Adding Anti-smurf Rules
Adding rules <span class="keyword">for</span> DHCP
Compiling TCP Flags filtering...
Compiling Kernel Route Filtering...
Compiling Martian Logging...
Compiling Accept Source Routing...
Compiling /etc/shorewall/export/rb450g/tcrules...
Compiling /etc/shorewall/export/rb450g/masq...
Compiling MAC Filtration -- Phase 1...
Compiling /etc/shorewall/export/rb450g/rules...
Compiling /usr/share/shorewall/action.Invalid <span class="keyword">for</span> chain %Invalid...
Compiling MAC Filtration -- Phase 2...
Applying Policies...
Generating Rule Matrix...
Creating iptables-restore input...
Shorewall configuration compiled to /etc/shorewall/export/rb450g/firewall
将会在当前目录生成firewall脚本，然后采用make install部署至firewall：
root@shorewall-centre-d6:/etc/shorewall/export/rb450g<span class="comment"># make install</span>
scp firewall firewall.conf root@192.168.44.1:/etc/shorewall-lite/state
root@192.168.44.1<span class="string">'s password:
firewall                                                                                                                             100%   79KB  79.3KB/s   00:00   
firewall.conf                                                                                                                        100%  862     0.8KB/s   00:00   
ssh root@192.168.44.1 "/sbin/shorewall-lite restart"
root@192.168.44.1'</span>s password:Restarting Shorewall Lite....
Initializing...
Processing init user <span class="keyword">exit</span> ...
Processing tcclear user <span class="keyword">exit</span> ...
Setting up Route Filtering...
Setting up Martian Logging...
Setting up Accept Source Routing...
Setting up Proxy ARP...
Setting up Traffic Control...
Preparing iptables-restore input...
Running /usr/sbin/iptables-restore...
IPv4 Forwarding EnabledProcessing start user <span class="keyword">exit</span> ...
Processing started user <span class="keyword">exit</span> ...
<span class="keyword">done</span>.
touch: /var/lock/subsys/shorewall: No such file or directory
</pre></figure>

<p>执行<code>make install</code>时，admin会将firewall、firewall.conf通过scp拷贝到firewall(rb450g)的/etc/shorewall-lite/state目录下，在firewall(rb450g)中执行/etc/init.d/shorewall-lite stop|start|restart均与该目录下的firewall脚本打交道。</p>
<p>以下是make install执行成功后，/etc/shorewall-lite/state的文件列表</p>
<figure class="highlight lang-bash"><pre>root@RB450G:/etc/shorewall-lite/state<span class="comment"># ls -alh</span>
drwxr-xr-x    1 root     root        2.0K Sep  3 13:49 .
drwxr-xr-x    1 root     root        2.0K Sep  3 11:05 ..
-rw-------    1 root     root           0 Sep  3 13:49 .dynamic
-rw-------    1 root     root        9.8K Sep  3 13:49 .iptables-restor
-rw-------    1 root     root        3.4K Sep  3 13:49 .modules
-rw-------    1 root     root          12 Sep  3 13:49 .modulesdir
-rw-r--r--    1 root     root        1.0K Sep  3 11:09 capabilities
-rwx------    1 root     root       79.3K Sep  3 13:43 firewall
-rw-------    1 root     root         862 Sep  3 13:43 firewall.conf
-rw-------    1 root     root         162 Sep  3 13:49 marks
-rw-------    1 root     root           0 Sep  3 13:49 nat
-rw-------    1 root     root         740 Sep  3 13:49 policies
-rw-------    1 root     root           0 Sep  3 13:49 proxyarp
-rw-------    1 root     root          29 Sep  3 13:49 restarted
-rw-------    1 root     root          74 Sep  3 13:49 state
-rw-------    1 root     root         110 Sep  3 13:49 zones
</pre></figure>

<h3>tricks</h3>
<p><strong>慎用iptables -F</strong></p>
<p>在清除规则之前，请先确认Chain INPUT的默认poliy，假如是：<code>Chain INPUT (policy DROP 0 packets, 0 bytes)</code>，则需要先<code>iptables -P INPUT ACCEPT</code>，然后<code>iptables -F</code>，否则会把自己锁在系统之外。</p>
<p><strong>涉及的网卡需起来</strong></p>
<p>在测试的过程中，发现tinc还没起来，导致shorewall make install失败。<br>将tinc配置好后，再make install就成功了。</p>
<p><strong>log</strong></p>
<p>选用shorewall/shorewall-lite的一个重要原因是shorewall log可根据<code>源zone+目的zones</code>分组，使得管理员可以迅速定位出错的规则。举个例子：</p>
<p>从lab中telnet corp的tinc vpn地址失败，于是查看双方的log日志，lab的日志无异样，corp则找到蛛丝马迹：</p>
<figure class="highlight lang-bash"><pre><span class="comment"># tail -f /var/log/ulogd.syslogemu | grep 10.8.0.65</span>
Sep  3 13:27:14 corp Shorewall:vpn2fw:REJECT: IN=tun0 OUT= MAC= SRC=10.8.0.1 DST=10.8.0.65 LEN=60 TOS=10 PREC=0x00 TTL=64 ID=19084 DF PROTO=TCP SPT=41748 DPT=23 SEQ=1825983957 ACK=0 WINDOW=5840 SYN URGP=0
</pre></figure>

<p>该log表明，10.8.0.1 telnet 10.8.0.65不满足vpn2fw的policy或rules，于是，我们只要在<code>/etc/shorewall/export/rb450g/rules</code>中的vpn2fw区域添加一条<code>TELNET(ACCEPT)    vpn    $FW</code>即可。</p>
<p>以下是shorewall的log配置</p>
<p>debian</p>
<figure class="highlight lang-bash"><pre><span class="comment"># sudo apt-get update</span>
<span class="comment"># sudo apt-get install iptables-mod-ulog kmod-ipt-ulog ulogd ulogd-mod-extra</span>
<span class="comment"># /etc/init.d/ulogd start</span>
</pre></figure>

<p>OpenWRT</p>
<figure class="highlight lang-bash"><pre><span class="comment"># opkg update</span>
<span class="comment"># opkg install iptables-mod-ulog kmod-ipt-ulog ulogd ulogd-mod-extra</span>
<span class="comment"># /etc/init.d/ulogd start</span>
</pre></figure>

<p>排错时再开启ulogd 默认情况下，会将log写到/var/log/ulogd.syslogemu中</p>
<p>shorewall极大简化了iptables的管理，然而与pf相比还是稍逊一筹，主要是shorewall的配置文件太多了。pf只需要一个配置文件，要简单、可爱得多。我认为它是世界上最优雅的防火墙。以lab为例：</p>
<p>/etc/pf.conf</p>
<figure class="highlight"><pre>wan_if = eth0
vpn_if = tun0
lab_vpn_net = <span class="string">"10.8.0.0/24"</span>
User1_vpn_net = <span class="string">"10.8.0.32/27"</span>
corp_vpn_net = <span class="string">"10.8.0.64/27"</span>

table &lt;lab_net&gt; { <span class="string">"192.168.33.0/24"</span>, <span class="string">"192.168.55.0/24"</span>
                  <span class="string">"192.168.66.0/24"</span>, <span class="string">"192.168.88.0/24"</span>
                  <span class="string">"192.168.100.0/24"</span>, <span class="string">"172.16.33.0/24"</span>
}

<span class="comment">###############</span>
<span class="comment"># 1:1 nat</span>

pass <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.33</span><span class="number">.231</span> <span class="keyword">to</span> any binat-<span class="keyword">to</span> <span class="number">10.8</span><span class="number">.0</span><span class="number">.2</span>
pass <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.33</span><span class="number">.232</span> <span class="keyword">to</span> any binat-<span class="keyword">to</span> <span class="number">10.8</span><span class="number">.0</span><span class="number">.3</span>
pass <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.33</span><span class="number">.233</span> <span class="keyword">to</span> any binat-<span class="keyword">to</span> <span class="number">10.8</span><span class="number">.0</span><span class="number">.4</span>
pass <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.33</span><span class="number">.234</span> <span class="keyword">to</span> any binat-<span class="keyword">to</span> <span class="number">10.8</span><span class="number">.0</span><span class="number">.5</span>
pass <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.66</span><span class="number">.21</span> <span class="keyword">to</span> any binat-<span class="keyword">to</span> <span class="number">10.8</span><span class="number">.0</span><span class="number">.6</span>
pass <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.66</span><span class="number">.22</span> <span class="keyword">to</span> any binat-<span class="keyword">to</span> <span class="number">10.8</span><span class="number">.0</span><span class="number">.7</span>
pass <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.66</span><span class="number">.23</span> <span class="keyword">to</span> any binat-<span class="keyword">to</span> <span class="number">10.8</span><span class="number">.0</span><span class="number">.8</span>
pass <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.55</span><span class="number">.120</span> <span class="keyword">to</span> any binat-<span class="keyword">to</span> <span class="number">10.8</span><span class="number">.0</span><span class="number">.9</span>
pass <span class="function_start"><span class="keyword">on</span> <span class="title">tun0</span></span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.120</span> <span class="keyword">to</span> any binat-<span class="keyword">to</span> <span class="number">10.8</span><span class="number">.0</span><span class="number">.10</span>

<span class="comment">###############</span>
<span class="comment"># masq</span>

<span class="comment"># lab中不需要用到masq，故以下配置被注释掉</span>
<span class="comment"># match out on $ext_if from !($vpn_if) to any nat-to ($vpn_if)</span>

block all

<span class="comment">###############</span>
<span class="comment"># rules</span>

<span class="comment"># wan2fw</span>
permit proto { udp, tcp } <span class="keyword">from</span> any <span class="keyword">to</span> $wan_if port <span class="number">655</span>

<span class="comment"># vpn2net</span>
permit proto tcp <span class="keyword">from</span> $User1_vpn_net <span class="keyword">to</span> &lt;lab_net&gt; port { <span class="number">22</span>,<span class="number">80</span>,<span class="number">443</span> }
permit <span class="keyword">from</span> $corp_vpn_net <span class="keyword">to</span> &lt;lab_net&gt;

<span class="comment"># all2all</span>
permit proto icmp all
</pre></figure>

<p>pf.conf支持table、list，甚至嵌套，大大减少了rules的条数，易于维护。</p>
<p>完成防火墙配置后，还要调整tinc配置。</p>
<h2>openbsd&amp;pfsense</h2>
<p>需开放openvpn访问tinc vpn的权限<br>pass log inet proto { tcp, udp } from <vpn_net> to <tinc_net></p>
<p>在“nat”的“openvpn”tab中，新建一条目标地址段为tinc_net的允许访问策略</p>
<h1>其它</h1>
<ol>
<li><p>OpenWRT on RB450G/RB493G</p>
</li>
<li><p>tinc的性能测试和调优</p>
</li>
</ol>
<p>OpenWRT on RB450G/RB493G</p>
<p>本文严重参考<a href="http://wiki.hwmn.org/w/Mikrotik_RouterBoard_450G，不敢冒功，特此指出。" target="_blank">http://wiki.hwmn.org/w/Mikrotik_RouterBoard_450G，不敢冒功，特此指出。</a></p>
<p>RB450G是MikkroTik公司出品的一款内置RouterOS的MIPS架构主板，CPU680Mhz，内存256M，nand512M，提供5个千兆网口，支持MicroSD和serial，性能远高于现市面上的无线路由设备。当然，它的售价也要高出许多。硬件规格高是一方面，另一个原因是RouterOS，它提供的路由、交换、VPN等功能特性非常丰富，目前在中低端市场，特别是欧洲占据了很大的市场份额。<br>RouterOS虽然基于linux，但却不开源，无法自行安装软件包，其灵活性比OpenWRT差得多，因而本文就教大家如何把OpenWRT AA刷入RB450G。</p>
<p>准备：<br>1台PC，windows或linux均可；<br>1条null modern串口线；<br>1条普通网线；</p>
<p>windows需安装tftpd32和bitvise SSH server这两个软件，其中，tftpd32负责提供dhcp server功能，bitvise SSH server负责提供ssh服务。</p>
<p>nand说明</p>
<p>boot loader设置</p>
<p>启动</p>
<p>加电后，立刻在SecuCRT中敲任意键，进入boot option界面</p>
<p>成功后将通过dhcp服务器下载initram的OpenWRT内核，并顺利进入操作系统，目前操作系统运行在内存中，因而需要把真正的img灌入nand</p>
<p>内存区的一部分用于跑临时OpenWRT，剩余的125M挂载到/tmp。</p>
<p>备份</p>
<p>1、通过winbox连接RB450G，备份出license.key<br>2、备份kernel和rootfs</p>
<figure class="highlight lang-bash"><pre><span class="comment"># cd /tmp</span>
<span class="comment"># dd if=/dev/mtd5 | gzip -9 &gt; routeros_kernel.img.gz</span>
<span class="comment"># dd if=/dev/mtd6 | gzip -9 &gt; routeros_rootfs.img.gz</span>
<span class="comment"># scp routeros_kernel.img.gz routeros_rootfs.img.gz username@laptop.ip:/e//backup</span>
</pre></figure>

<p>!!警告!!<br>创建rootfs.img.gz的过程非常慢，估计是gzip用了-9这个参数。<br>创建rootfs.img.gz结束后，跳出xx的提示，<br>kernel.img.gz为1.8M，rootfs.img.gz为123.3M，尺寸之和两者正好是125.1M，因而不确定通过dd备份出来的rootfs是否完整。在原文中，作者也没有做倒回测试，后果自负。</p>
<p>下载<br>从<a href="http://downloads.openwrt.org/attitude_adjustment/12.09/ar71xx/nand/下载openwrt-ar71xx-nand-vmlinux.elf和openwrt-ar71xx-nand-rootfs.tar.gz这两个文件，并放到e:\backup目录中，一会儿会用到。" target="_blank">http://downloads.openwrt.org/attitude_adjustment/12.09/ar71xx/nand/下载openwrt-ar71xx-nand-vmlinux.elf和openwrt-ar71xx-nand-rootfs.tar.gz这两个文件，并放到e:\backup目录中，一会儿会用到。</a></p>
<p>刷机</p>
<figure class="highlight lang-bash"><pre><span class="comment"># cd /tmp</span>
<span class="comment"># scp username@laptop.ip:/e//backup//openwrt-ar71xx-nand-vmlinux.elf .</span>
<span class="comment"># scp username@laptop.ip:/e//backup//openwrt-ar71xx-nand-rootfs.tar.gz .</span>
<span class="comment"># mtd erase kernel</span>
<span class="comment"># mount -t yaffs /dev/mtdblock5 /mnt</span>
<span class="comment"># cp openwrt-ar71xx-nand-vmlinux.elf /mnt/kernel</span>
<span class="comment"># umount /mnt</span>
<span class="comment"># mtd erase rootfs</span>
<span class="comment"># mount -t yaffs /dev/mtdblock6 /mnt</span>
<span class="comment"># cd /mnt</span>
<span class="comment"># tar xpzf /tmp/openwrt-ar71xx-nand-rootfs.tar.gz</span>
<span class="comment"># cd /tmp</span>
<span class="comment"># umount /mnt</span>
</pre></figure>

<p>说明：<br>mtd erase rootfs的时候，出现bad erase block的提示，我放狗搜了一下，发现是正常现象[<a href="http://wiki.openmoko.org/wiki/NAND_bad_blocks]，只要bad" target="_blank">http://wiki.openmoko.org/wiki/NAND_bad_blocks]，只要bad</a> block的尺寸不超过1%即可放心使用。每个block大小为1/2KB。</p>
<p>刷完之后，reboot即可进入OpenWRT AA。</p>
<h2>nand bad block</h2>
<p><a href="http://wiki.openmoko.org/wiki/NAND_bad_blocks有详细的说明，以下是网友的回复。" target="_blank">http://wiki.openmoko.org/wiki/NAND_bad_blocks有详细的说明，以下是网友的回复。</a></p>
<p>This is only a warning.</p>
<p>It is issued by the MTD driver while scanning for bad blocks in the flash<br>device. see: drivers/mtd/nand/nand_bbt.c :</p>
<p>printk (KERN_WARNING &quot;Bad eraseblock %d at 0x%08x\n&quot;, i &gt;&gt; 1, (unsigned int)<br>from);</p>
<p>The device is still good!</p>
<p>NAND devices, like hard drives, ship with bad blocks to increase yield, and<br>reducing cost. They also develop bad blocks over time. The Kernel keeps track<br>of these bad blocks so the filesystem knows not to use them.</p>
<p>Each block consists of 32 pages, and each page has a 1/2 K. So you lose 16 KB<br>for each bad block. (Which isn&#39;t bad for 128MB flash system).</p>
<p>Unfortunately the TS boot code does not check for errors or bad blocks when it<br>loads the 256KB Redboot image from flash. So if you have a bad block in this<br>area, your system could fail to boot with no error message.</p>
<p>I have build a 2K ARM assembly language boot loader that will correct and<br>detect errors as it loads the 256KB Redboot image from flash. It is part of<br>the “Serial Blaster” project (to be launched in alpha version, for the<br>TS7250, soon).</p>
<p>-Curtis.</p>
<p>源文档 <a href="http://tech.groups.yahoo.com/group/ts-7000/message/1368" target="_blank">http://tech.groups.yahoo.com/group/ts-7000/message/1368</a> </p>
<p>The TS-7250 uses Nand flash, Nand flash is much different than Nor<br>flash(if you are interested there is a pretty good write up here<br><a href="http://support.gateway.com/s/Manuals/Desktops/5502664/NOR_vs_NANDwhitepaper.pdf)\" target="_blank">http://support.gateway.com/s/Manuals/Desktops/5502664/NOR_vs_NANDwhitepaper.pdf)\</a><br>.<br>Basically Nand flash is sometimes shipped from the manufacturer with bad<br>blocks, in addition blocks will become bad over time. The general<br>consensus is not to worry if your flash consists of 1% or less bad<br>blocks. Nand flash has out of band data which basically stores meta data,<br>this is where a block is marked bad. The filesystem(Yaffs) handles this<br>and will ensure data is not written to any block marked as bad. The<br>bottom line is the messages your are seeing are benign, unless the number<br>of bad blocks exceeds 1%.</p>
<p>源文档 <a href="http://tech.groups.yahoo.com/group/ts-7000/message/1367" target="_blank">http://tech.groups.yahoo.com/group/ts-7000/message/1367</a> </p>
<h1>tinc on RB450G</h1>
<h2>性能测试</h2>
<p>Linksys WRT54G(CPU: 200Mhz RAM: 64M)<br>从lab到User2之间互传文件<br>Mem: 27496K used, 34260K free, 0K shrd, 1848K buff, 9804K cached<br>CPU:  48% usr  35% sys   0% nic   0% idle   0% io   0% irq  16% sirq<br>Load average: 0.86 0.39 0.31 3/49 2960</p>
<p>利用scp传送文件<br>从lab到User2：130B/s-180KB/s</p>
<p>当再登录User2的时候，已经出现无法响应的现象。</p>
<p>Linksys WRT54G(CPU: 200Mhz RAM: 64M)<br>从lab到User2之间互传文件<br>Mem: 27840K used, 33916K free, 0K shrd, 1848K buff, 9804K cached<br>CPU:  51% usr  29% sys   0% nic   0% idle   0% io   0% irq  19% sirq<br>Load average: 1.55 1.22 0.82 3/47 3082</p>
<p>利用scp传送文件<br>从corp到User2：101KB/s-123KB/s<br>从User2到corp：30KB/s-50KB/s</p>
<p>速率的跨度比较大，在console中按键有响应，有停滞。</p>
<p>RB450G(CPU: 680Mhz RAM: 256M)<br>从lab到User2之间互传文件<br>Mem: 26388K used, 230244K free, 0K shrd, 0K buff, 10168K cached<br>CPU:  46% usr  39% sys   0% nic   0% idle   0% io   0% irq  13% sirq<br>Load average: 1.40 0.90 0.64 2/45 4382</p>
<p>利用scp传送文件<br>从lab到User2：160B/s-180KB/s<br>从User2到lab：620KB/s-650KB/s</p>
<p>User2和corp之间互传文件<br>Mem: 26772K used, 229860K free, 0K shrd, 0K buff, 10168K cached<br>CPU:  44% usr  39% sys   0% nic   0% idle   0% io   0% irq  16% sirq<br>Load average: 1.28 0.95 0.70 2/45 4413</p>
<p>利用scp传送文件<br>从corp到User2：250KB/s-320KB/s<br>从User2到corp：600KB/s-690KB/s</p>
<p>使用winscp传送文件<br>从corp到User2（直传）：600-800KB/s<br>从corp到User2（tinc）：600-800KB/s<br>tinc对速率的影响不大。</p>
<p>其中lab经过两段VPN方达到User2，corp仅经过一段即达到User2，然而测试的结果相差无几，可以看到的是双向传输文件时，corp的OpenWRT网关的CPU利用率达到了46%。</p>
<p>由此看出，Linksys WRT54G对于tinc来说还是力不从心，CPU太慢。有可能的话，还是上x86的低能耗平台吧，譬如atom。</p>
<h2>性能调优</h2>
<p>User1到lab<br>scp速度在1.0MB/s左右</p>
<p>尝试<br>1、<br>/etc/tinc/mgmt/tinc.conf</p>
<h1>Cipher = none</h1>
<h1>Compression = 0</h1>
<h1>Digest = none</h1>
<p>然后重启，无效，估计是因为隧道跑在tcp上，而以上3个参数只对udp起作用<br>2、<br>/etc/tinc/mgmt/tinc-up<br>ip link set mtu 1350 dev $INTERFACE<br>iptables -A FORWARD -p tcp -m tcp —tcp-flags SYN,RST SYN -j TCPMSS —clamp-mss-to-pmtu</p>
<p>也没什么作用<br>3、<br>nice -n -20 tincd -n mgmt -d3<br>没什么用</p>
<p>4、<br>限制tcp:655端口，强制tincd通过udp连接，失败<br>iptables -A INPUT -i eth0 -p tcp —destion-port 655 -j DROP<br>原因可能是因为lab和User2都在防火墙在之后，虽然是1:1映射，但仍然无法建立udp连接。</p>
<p>非常巧，debian squeeze backports和OpenWRT AA的tinc版本均为1.0.19。也许作者已经把以上几种性能调优的方式在源代码中实现了。</p>
<p><strong>脚注1</strong></p>
<p>关于移动宽带</p>
<p>由于运营商的不对称管制，导致移动宽带用户的互联网访问感知很差，原因是大部分的IDC资源均在电信侧。为了缓解这种矛盾，移动公司将部分互联网流量通过第三方通道流向chinanet，使用感知得到了提升，然而却给终端用户带来一些麻烦，特别是无法正常使用动态域名。原因是：</p>
<ol>
<li>由于通过不同链路出去，故拥有多个互联网IP地址；</li>
<li>第三方提供的互联网ip只允许outbound，不允许inbound，甚至禁ping。</li>
</ol>
<p>好在tinc既可以做server，也可以做client。当作为client的时候，本机的hosts文件中的Address即便不是真实的，也无关紧要。因而移动宽带用户即便没有使用动态域名解析，也能正常使用tinc client。</p>
<p><strong>脚注2</strong></p>
<p>倘若希望lab和User1之间内部网段的互访，各自核心交换机需将对方网段指向本节点的tinc网关：</p>
<p><strong>lab huawei S5328</strong></p>
<figure class="highlight"><pre>ip route 192.168.44.0 255.255.255.0 <span class="tag">&lt;<span class="title">lab</span> <span class="attribute">lan</span> <span class="attribute">ip</span>&gt;</span> desc to corp
ip route 192.168.77.0 255.255.255.0 <span class="tag">&lt;<span class="title">lab</span> <span class="attribute">lan</span> <span class="attribute">ip</span>&gt;</span> desc to corp

ip route 10.1.0.0 255.255.255.0 <span class="tag">&lt;<span class="title">User1</span> <span class="attribute">lan</span> <span class="attribute">ip</span>&gt;</span> desc to User1
ip route 10.2.0.0 255.255.255.0 <span class="tag">&lt;<span class="title">User1</span> <span class="attribute">lan</span> <span class="attribute">ip</span>&gt;</span> desc to User1
ip route 10.3.0.0 255.255.0.0 <span class="tag">&lt;<span class="title">User1</span> <span class="attribute">lan</span> <span class="attribute">ip</span>&gt;</span> desc to User1
ip route 10.168.1.0 255.255.255.0 <span class="tag">&lt;<span class="title">User1</span> <span class="attribute">lan</span> <span class="attribute">ip</span>&gt;</span> desc to User1
ip route 10.168.9.0 255.255.255.0 <span class="tag">&lt;<span class="title">User1</span> <span class="attribute">lan</span> <span class="attribute">ip</span>&gt;</span> desc to User1
ip route 192.168.200.0 255.255.255.0 <span class="tag">&lt;<span class="title">User1</span> <span class="attribute">lan</span> <span class="attribute">ip</span>&gt;</span> desc to User1

ip route 10.8.0.0 255.255.255.0 <span class="tag">&lt;<span class="title">lab</span> <span class="attribute">lan</span> <span class="attribute">ip</span>&gt;</span> desc to local tinc gw
</pre></figure>

<p><strong>User1 H3C S5500</strong></p>
<figure class="highlight"><pre>ip route 192.168.44.0 255.255.255.0 <span class="tag">&lt;<span class="title">User1</span> <span class="attribute">lan</span> <span class="attribute">ip</span>&gt;</span> desc to corp
ip route 192.168.77.0 255.255.255.0 <span class="tag">&lt;<span class="title">User1</span> <span class="attribute">lan</span> <span class="attribute">ip</span>&gt;</span> desc to corp

ip route 192.168.33.0 255.255.255.0 <span class="tag">&lt;<span class="title">User1</span> <span class="attribute">lan</span> <span class="attribute">ip</span>&gt;</span> desc to lab
ip route 192.168.55.0 255.255.255.0 <span class="tag">&lt;<span class="title">User1</span> <span class="attribute">lan</span> <span class="attribute">ip</span>&gt;</span> desc to lab
ip route 192.168.66.0 255.255.255.0 <span class="tag">&lt;<span class="title">User1</span> <span class="attribute">lan</span> <span class="attribute">ip</span>&gt;</span> desc to lab
ip route 192.168.88.0 255.255.255.0 <span class="tag">&lt;<span class="title">User1</span> <span class="attribute">lan</span> <span class="attribute">ip</span>&gt;</span> desc to lab
ip route 10.8.0.0 255.255.255.0 <span class="tag">&lt;<span class="title">User1</span> <span class="attribute">lan</span> <span class="attribute">ip</span>&gt;</span> desc to local tinc gw
</pre></figure>


      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/openwrt/">openwrt</a>, <a href="/categories/openwrt/vpn/">vpn</a>, <a href="/categories/openwrt/vpn/network/">network</a>
  </div>

        
        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:ioiioi.github.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/RouterOS/MikroTik/">MikroTik</a><small>2</small></li>
  
    <li><a href="/categories/RouterBOARD/">RouterBOARD</a><small>1</small></li>
  
    <li><a href="/categories/RouterOS/">RouterOS</a><small>4</small></li>
  
    <li><a href="/categories/VPS/">VPS</a><small>1</small></li>
  
    <li><a href="/categories/openwrt/ap/">ap</a><small>1</small></li>
  
    <li><a href="/categories/confluence/">confluence</a><small>1</small></li>
  
    <li><a href="/categories/debian/">debian</a><small>12</small></li>
  
    <li><a href="/categories/dhcp/debian/">debian</a><small>1</small></li>
  
    <li><a href="/categories/dns/debian/">debian</a><small>1</small></li>
  
    <li><a href="/categories/ldap/debian/">debian</a><small>1</small></li>
  
    <li><a href="/categories/dhcp/">dhcp</a><small>1</small></li>
  
    <li><a href="/categories/dns/">dns</a><small>1</small></li>
  
    <li><a href="/categories/debian/domU/">domU</a><small>1</small></li>
  
    <li><a href="/categories/ubuntu/domU/">domU</a><small>1</small></li>
  
    <li><a href="/categories/embeded/">embeded</a><small>1</small></li>
  
    <li><a href="/categories/freebsd/">freebsd</a><small>1</small></li>
  
    <li><a href="/categories/illumos/">illumos</a><small>1</small></li>
  
    <li><a href="/categories/iptable/">iptable</a><small>1</small></li>
  
    <li><a href="/categories/virtualization/iscsi/">iscsi</a><small>1</small></li>
  
    <li><a href="/categories/xen/kvm/">kvm</a><small>1</small></li>
  
    <li><a href="/categories/kvm/">kvm</a><small>1</small></li>
  
    <li><a href="/categories/network/ldap/">ldap</a><small>1</small></li>
  
    <li><a href="/categories/ldap/">ldap</a><small>1</small></li>
  
    <li><a href="/categories/openwrt/linksys/">linksys</a><small>1</small></li>
  
    <li><a href="/categories/linux/">linux</a><small>1</small></li>
  
    <li><a href="/categories/linux/netbsd/">netbsd</a><small>1</small></li>
  
    <li><a href="/categories/openbsd/netmgmt/">netmgmt</a><small>1</small></li>
  
    <li><a href="/categories/openwrt/vpn/network/">network</a><small>1</small></li>
  
    <li><a href="/categories/debian/network/">network</a><small>2</small></li>
  
    <li><a href="/categories/network/">network</a><small>3</small></li>
  
    <li><a href="/categories/networking/">networking</a><small>1</small></li>
  
    <li><a href="/categories/nexenta/">nexenta</a><small>4</small></li>
  
    <li><a href="/categories/octopress/">octopress</a><small>3</small></li>
  
    <li><a href="/categories/debian/octopress/">octopress</a><small>2</small></li>
  
    <li><a href="/categories/openSUSE/">openSUSE</a><small>2</small></li>
  
    <li><a href="/categories/openbsd/">openbsd</a><small>8</small></li>
  
    <li><a href="/categories/openbsd openntpd/">openbsd openntpd</a><small>1</small></li>
  
    <li><a href="/categories/openwrt/">openwrt</a><small>4</small></li>
  
    <li><a href="/categories/others/">others</a><small>1</small></li>
  
    <li><a href="/categories/seafile/">seafile</a><small>1</small></li>
  
    <li><a href="/categories/seafile/services/">services</a><small>1</small></li>
  
    <li><a href="/categories/linux/netbsd/solaris/">solaris</a><small>1</small></li>
  
    <li><a href="/categories/RouterBOARD/solaris11/">solaris11</a><small>1</small></li>
  
    <li><a href="/categories/solaris11/">solaris11</a><small>1</small></li>
  
    <li><a href="/categories/tech/">tech</a><small>1</small></li>
  
    <li><a href="/categories/tech/tips/">tips</a><small>1</small></li>
  
    <li><a href="/categories/ubuntu/">ubuntu</a><small>1</small></li>
  
    <li><a href="/categories/vim/">vim</a><small>1</small></li>
  
    <li><a href="/categories/windows/virtualbox/">virtualbox</a><small>1</small></li>
  
    <li><a href="/categories/virtualbox/">virtualbox</a><small>5</small></li>
  
    <li><a href="/categories/debian/virtualbox/">virtualbox</a><small>1</small></li>
  
    <li><a href="/categories/virtualization/">virtualization</a><small>2</small></li>
  
    <li><a href="/categories/kvm/virtualization/">virtualization</a><small>1</small></li>
  
    <li><a href="/categories/openwrt/vpn/">vpn</a><small>1</small></li>
  
    <li><a href="/categories/vpn/">vpn</a><small>1</small></li>
  
    <li><a href="/categories/windows/">windows</a><small>1</small></li>
  
    <li><a href="/categories/virtualization/xen/">xen</a><small>1</small></li>
  
    <li><a href="/categories/ubuntu/domU/xen/">xen</a><small>1</small></li>
  
    <li><a href="/categories/xen/">xen</a><small>2</small></li>
  
    <li><a href="/categories/debian/domU/xen/">xen</a><small>1</small></li>
  
    <li><a href="/categories/illumos/zfs/">zfs</a><small>1</small></li>
  
    <li><a href="/categories/xen/kvm/虚拟化/">虚拟化</a><small>1</small></li>
  
  </ul>
</div>


  
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2013 alfie chan
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>